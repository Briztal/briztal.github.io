<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Trading bot : trade sequence. &#183;</title><meta name=title content="Trading bot : trade sequence. &#183; "><meta name=description content="How the trading bot trades."><link rel=canonical href=briztal.github.io/projects/bot/bot_3_seq/><link type=text/css rel=stylesheet href=/briztal.github.io/css/main.bundle.min.29653ed199b7a749016920bb9715d240156e67049c90f12ffede5bb7f952606ecd8b0dd0c3f01d75af648960eddb25a879915d6e24858a75d11d9eed0607d9c6.css integrity="sha512-KWU+0Zm3p0kBaSC7lxXSQBVuZwSckPEv/t5bt/lSYG7Niw3Qw/Adda9kiWDt2yWoeZFdbiSFinXRHZ7tBgfZxg=="><script type=text/javascript src=/briztal.github.io/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script>
<script defer type=text/javascript id=script-bundle src=/briztal.github.io/js/main.bundle.min.5155d528b5217d2be660e88e103a0553710d2c94c85e3221100642905f3e6cbbb67b3760a44ab4f36703f12fbfe1d6f5b4545c3ae3a3f34784d919904ab7f1d7.js integrity="sha512-UVXVKLUhfSvmYOiOEDoFU3ENLJTIXjIhEAZCkF8+bLu2ezdgpEq082cD8S+/4db1tFRcOuOj80eE2RmQSrfx1w==" data-copy=Copy data-copied=Copied></script>
<script src=/briztal.github.io/lib/zoom/zoom.min.f592a181a15d2a5b042daa7f746c3721acf9063f8b6acd175d989129865a37d400ae0e85b640f9ad42cd98d1f8ad30931718cf8811abdcc5fcb264400d1a2b0c.js integrity="sha512-9ZKhgaFdKlsELap/dGw3Iaz5Bj+Las0XXZiRKYZaN9QArg6FtkD5rULNmNH4rTCTFxjPiBGr3MX8smRADRorDA=="></script>
<link rel=apple-touch-icon sizes=180x180 href=/briztal.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/briztal.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/briztal.github.io/favicon-16x16.png><link rel=manifest href=/briztal.github.io/site.webmanifest><meta property="og:title" content="Trading bot : trade sequence."><meta property="og:description" content="How the trading bot trades."><meta property="og:type" content="article"><meta property="og:url" content="briztal.github.io/projects/bot/bot_3_seq/"><meta property="article:section" content="projects"><meta property="article:published_time" content="2025-07-19T00:00:00+00:00"><meta property="article:modified_time" content="2025-07-19T00:00:00+00:00"><meta property="og:see_also" content="briztal.github.io/projects/bot/bot_2_prv/"><meta property="og:see_also" content="briztal.github.io/projects/bot/bot_1_top/"><meta property="og:see_also" content="briztal.github.io/projects/bot/bot_0_intro/"><meta name=twitter:card content="summary"><meta name=twitter:title content="Trading bot : trade sequence."><meta name=twitter:description content="How the trading bot trades."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Personal Projects","name":"Trading bot : trade sequence.","headline":"Trading bot : trade sequence.","abstract":"How the trading bot trades.","inLanguage":"en","url":"briztal.github.io\/projects\/bot\/bot_3_seq\/","author":{"@type":"Person","name":""},"copyrightYear":"2025","dateCreated":"2025-07-19T00:00:00\u002b00:00","datePublished":"2025-07-19T00:00:00\u002b00:00","dateModified":"2025-07-19T00:00:00\u002b00:00","mainEntityOfPage":"true","wordCount":"4620"}]</script><script src=/briztal.github.io/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/briztal.github.io class="text-base font-medium text-gray-500 hover:text-gray-900"></a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=briztal.github.io/projects/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title="Personal Projects">Projects</p></a><a href=briztal.github.io/about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title="About me">About</p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-1 rtl:ml-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><label id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=briztal.github.io/projects/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title="Personal Projects">Projects</p></a></li><li class=mt-1><a href=briztal.github.io/about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title="About me">About</p></a></li></ul></div></label></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Trading bot : trade sequence.</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-07-19T00:00:00+00:00>19 July 2025</time></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("briztal.github.io/categories/trading-bot/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Trading bot</span></span></span></div></div><div class="flex author"><div class=place-self-center><div class="text-2xl sm:text-lg"></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#abstract-objectives>Abstract objectives</a></li><li><a href=#trade-scenarios>Trade scenarios</a></li><li><a href=#fsm>FSM</a></li><li><a href=#improvements>Improvements</a><ul><li><a href=#1--sell-only-when-the-price-decreases>1 : Sell only when the price decreases</a></li><li><a href=#2--divide-the-buy-stage-in-multiple-steps>2 : divide the buy stage in multiple steps</a></li><li><a href=#3--add-a-trg-step-between-mon-and-sel>3 : add a TRG step between MON and SEL</a></li></ul></li><li><a href=#visual-logs>Visual logs</a><ul><li><a href=#self-backtesting--aapl_aapl_1d>Self backtesting : aapl_aapl_1d</a></li><li><a href=#no-correlation--predict-nvda-based-on-aapl>No correlation : predict NVDA based on AAPL</a></li><li><a href=#when-it-goes-_bang_--predict-aapl-based-on-nvda>When it goes <em>bang</em> : predict AAPL based on NVDA</a></li></ul></li><li><a href=#conclusion>Conclusion.</a></li><li><a href=#abstract-objectives-1>Abstract objectives</a></li><li><a href=#trade-scenarios-1>Trade scenarios</a></li><li><a href=#fsm-1>FSM</a></li><li><a href=#improvements-1>Improvements</a><ul><li><a href=#1--sell-only-when-the-price-decreases-1>1 : Sell only when the price decreases</a></li><li><a href=#2--divide-the-buy-stage-in-multiple-steps-1>2 : divide the buy stage in multiple steps</a></li><li><a href=#3--add-a-trg-step-between-mon-and-sel-1>3 : add a TRG step between MON and SEL</a></li></ul></li><li><a href=#visual-logs-1>Visual logs</a><ul><li><a href=#self-backtesting--aapl_aapl_1d-1>Self backtesting : aapl_aapl_1d</a></li><li><a href=#no-correlation--predict-nvda-based-on-aapl-1>No correlation : predict NVDA based on AAPL</a></li><li><a href=#when-it-goes-_bang_--predict-aapl-based-on-nvda-1>When it goes <em>bang</em> : predict AAPL based on NVDA</a></li></ul></li><li><a href=#conclusion-1>Conclusion.</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#abstract-objectives>Abstract objectives</a></li><li><a href=#trade-scenarios>Trade scenarios</a></li><li><a href=#fsm>FSM</a></li><li><a href=#improvements>Improvements</a><ul><li><a href=#1--sell-only-when-the-price-decreases>1 : Sell only when the price decreases</a></li><li><a href=#2--divide-the-buy-stage-in-multiple-steps>2 : divide the buy stage in multiple steps</a></li><li><a href=#3--add-a-trg-step-between-mon-and-sel>3 : add a TRG step between MON and SEL</a></li></ul></li><li><a href=#visual-logs>Visual logs</a><ul><li><a href=#self-backtesting--aapl_aapl_1d>Self backtesting : aapl_aapl_1d</a></li><li><a href=#no-correlation--predict-nvda-based-on-aapl>No correlation : predict NVDA based on AAPL</a></li><li><a href=#when-it-goes-_bang_--predict-aapl-based-on-nvda>When it goes <em>bang</em> : predict AAPL based on NVDA</a></li></ul></li><li><a href=#conclusion>Conclusion.</a></li><li><a href=#abstract-objectives-1>Abstract objectives</a></li><li><a href=#trade-scenarios-1>Trade scenarios</a></li><li><a href=#fsm-1>FSM</a></li><li><a href=#improvements-1>Improvements</a><ul><li><a href=#1--sell-only-when-the-price-decreases-1>1 : Sell only when the price decreases</a></li><li><a href=#2--divide-the-buy-stage-in-multiple-steps-1>2 : divide the buy stage in multiple steps</a></li><li><a href=#3--add-a-trg-step-between-mon-and-sel-1>3 : add a TRG step between MON and SEL</a></li></ul></li><li><a href=#visual-logs-1>Visual logs</a><ul><li><a href=#self-backtesting--aapl_aapl_1d-1>Self backtesting : aapl_aapl_1d</a></li><li><a href=#no-correlation--predict-nvda-based-on-aapl-1>No correlation : predict NVDA based on AAPL</a></li><li><a href=#when-it-goes-_bang_--predict-aapl-based-on-nvda-1>When it goes <em>bang</em> : predict AAPL based on NVDA</a></li></ul></li><li><a href=#conclusion-1>Conclusion.</a></li></ul></nav></div></details><script></script></div></div><div class="min-w-0 min-h-0 max-w-fit"><details style=margin-left:0 class="mt-2 mb-5 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5" open><summary class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-primary-800 dark:text-neutral-100">Trading_bot - This article is part of a series.</summary><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=briztal.github.io/projects/bot/bot_0_intro/>Part 0: Trading bot : introduction</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=briztal.github.io/projects/bot/bot_1_top/>Part 1: Trading core : high level view</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=briztal.github.io/projects/bot/bot_2_prv/>Part 2: Trading bot : data provider.</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">Part 3: This Article</div></details><div class="article-content max-w-prose mb-20"><p>s chapter elaborates on how the algorithm that passes orders given the prediction made by a strategy.</p><p>It will also serve as an opportunity to show the backtesting in action.</p><p>The implemented algorithm specializes in trading securities in a simple way, it buys a security, then attempts to sell it at a higher price.</p><p>While this appears simple, there are subtleties to understand and precautions to take when doing such a simple task.</p><p>Trading more complex instruments, or trading securities using different techniques would undoubtedly involve more complex trade sequences, but the constraints and objectives of this simple model would still apply.</p><h2 class="relative group">Abstract objectives<div id=abstract-objectives class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#abstract-objectives aria-label=Anchor>#</a></span></h2><p>The trade sequence is the code block that given :</p><ul><li>an instrument;</li><li>a prediction on the future price of this instrument made by a strategy;</li><li>a given amount of money in the instrument&rsquo;s trading currency, determined by the allocator;
creates and manages orders to extract a profit from the prediction.</li></ul><p>Its order management algorithm must be precise and bug-free, as it must avoid at all costs :</p><ul><li>using more money than allowed by the allocator which would put the portfolio in money deficit.</li><li>selling more units of the target instruments than the amount that it has previously bought which would put the portfolio in asset deficit.</li><li>loosing track of orders, which would make resources vanish from the portfolio.</li></ul><p>The last part has a subtlety implied by my design choices.</p><p>A look at the trading bot&rsquo;s high level diagram will show that the trade sequence is the bot&rsquo;s only entity that manages orders.</p><p>An implication of this is that if we aim at deleting a trade sequence, we must ensure that all its orders are eiter complete or cancelled.</p><p>The trading bot is regularly exported to allow fail safety, and stopping it does not cause a trade sequence deletion. It just means that when restarting the bot again, the trade sequence will be resumed, accounting for the same orders as before stopping teh bot.</p><h2 class="relative group">Trade scenarios<div id=trade-scenarios class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#trade-scenarios aria-label=Anchor>#</a></span></h2><p>The base algorithm of the trade sequence will be divided into three phases :</p><ul><li>buying : buy a certain number of units of the target instrument;</li><li>monitoring : wait for the target price to be reached;</li><li>selling : sell the bought units;</li></ul><p>This is very simple in theory, but there are subtleties that add to it.</p><p>Buying constraints :</p><ul><li>buying can take time, and we do not want to buy if the price is already too high. Remember that we are low latency after all.</li><li>buying can take time and we do not want to buy after a certain time past the prediction. The prediction may be incorrect after all.</li><li>the prediction implies a future price increase, but if the price goes down, we may want to consider it unreliable and not buy.</li><li>the buy order may not be completely executed, and we may end up with less units than expected.</li></ul><p>Monitoring constraints :</p><ul><li>the prediction may be incorrect and the target price could not be reached in time. We must not wait indefinitely and just sell after some time.</li><li>the prediction may be incorrect and the price may decrease after buying. We must set a stop loss price and sell if it is reached.</li></ul><p>Selling is a critical part of the trade sequence as it is necessary for the trade sequence to be deletable. Hence, it should be as flexible as possible, and in practice, has no constraints. We just buy as many units as we have, with a market sell order.</p><h2 class="relative group">FSM<div id=fsm class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#fsm aria-label=Anchor>#</a></span></h2><p>With the constraints listed so far, we can come up with a simple algorithm which behaves like an FSM.</p><p>It receives the following parameters :</p><ul><li><code>mny</code> : the amount of money to invest.</li><li><code>prc_buy</code> : the maximal buy price.</li><li><code>prc_tgt</code> : the target sell price.</li><li><code>prc_stp</code> : the minimal stop price.</li><li><code>buy_tim</code> : the maximal time allowed to buy.</li><li><code>mon_tim</code> : the maximal time allowed to monitor.</li></ul><p>Its states are :</p><ul><li>BUY : a single buy order for <code>mny</code> has been issued and we are waiting for its completion.<ul><li>If the order completes without cancellation, move to MON.</li><li>If the current price becomes lower than <code>prc_stp</code>, or if <code>buy_tim</code> is ellapsed, cancel it and move to SEL, as the buy order may have been partially executed.</li></ul></li><li>MON : the buy order has been executed and we are monitoring the current price.<ul><li>If the price goes above <code>prc_tgt</code>, move to SEL (or to <code>TRG</code> if implemented, see the Improvements section below).</li><li>If the price goes below <code>prc_stp</code>, or if <code>mon_tim</code> is ellapsed, move to SEL.</li></ul></li><li>SEL : the buy order has been executed, and the sell market order has been issued.<ul><li>If the sell order has been partially executed, re-issue one covering the remaining units.</li><li>If the sell order has been completely executed, move to DON.</li></ul></li><li>DON : all orders have been completed, ready for deletion.</li></ul><h2 class="relative group">Improvements<div id=improvements class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#improvements aria-label=Anchor>#</a></span></h2><p>This section covers potential improvements to the trade sequence to increase profits or predictability.</p><p>Note that even those mechanisms may seem interesting per-se, they may not provide any benefit <em>without</em> <em>a</em> <em>valid</em> <em>prediction</em>.</p><p>They provide a benefit only because (shoudl I say : <code>if</code>) the prediction itself has valid information. They do not provide information per-se. They <code>could</code> simply allow us to get closer to the predicted return by handling more corner cases in the market&rsquo;s behavior.</p><p>Their use and characteristics should be subject to backtesting, as they may be profitable or not based on the market conditions.</p><h3 class="relative group">1 : Sell only when the price decreases<div id=1--sell-only-when-the-price-decreases class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1--sell-only-when-the-price-decreases aria-label=Anchor>#</a></span></h3><p>That will allow us to take advantage of a rising market.</p><p>The strategy&rsquo;s predictor only makes a prediction on the return between <code>now</code> and <code>now</code> + <code>some time</code>. It says nothing about what happens next, and if the price keeps going up, there is no reason for us to sell early.</p><p>To implement this, we need to establish a price drop percentage after which we sell.</p><h3 class="relative group">2 : divide the buy stage in multiple steps<div id=2--divide-the-buy-stage-in-multiple-steps class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2--divide-the-buy-stage-in-multiple-steps aria-label=Anchor>#</a></span></h3><p>If the target instrument is volatile, it may be a good idea to not buy all units at the same time. In average this will not matter as we will have multiple trade sequences, which should average the volatility with time, but by handling this at the buy stage, we avoid propagating the volatility to the trade sequences performances, and be more predictable which matters to us.</p><h3 class="relative group">3 : add a TRG step between MON and SEL<div id=3--add-a-trg-step-between-mon-and-sel class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#3--add-a-trg-step-between-mon-and-sel aria-label=Anchor>#</a></span></h3><p>If the target price has been reached, we try selling using a limit sell order for some time. If we could not sell all after this time, we enter the SEL stage and sell everything with a market order.</p><p>It allows us to only be affected by the positive side of volatility : if price temporarily goes down, we will not sell. If it goes up, we will sell at a better price.</p><p>The counterpart of this is that if the prices goes down in a non-temporary manner, we will sell too late and at a potentially lesser price.</p><h2 class="relative group">Visual logs<div id=visual-logs class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#visual-logs aria-label=Anchor>#</a></span></h2><p>For my testing I generated a lot of simulations to both test the bot&rsquo;s correctness and its ability to correctly (or not) take advantage of a prediction.</p><p>From the bot&rsquo;s logs, some nice graphs can be generated, to visually ensure that the bot&rsquo;s trade sequence does the right thing.</p><p>The python script that I wrote to generate the visual reports can be found <a href=https://github.com/Briztal/kr_public/blob/master/bot_rep.py target=_blank>here</a> and uses the <code>rep</code> package proviced <a href=https://github.com/Briztal/kr_public/blob/master/rep/ target=_blank>here</a> :</p><ul><li><a href=https://github.com/Briztal/kr_public/blob/master/rep/cmd.py target=_blank>cmd</a> : parsing utilities.</li><li><a href=https://github.com/Briztal/kr_public/blob/master/rep/rep.py target=_blank>rep</a> : reprot python structures.</li><li><a href=https://github.com/Briztal/kr_public/blob/master/rep/prs.py target=_blank>prs</a> : log parsing.</li><li><a href=https://github.com/Briztal/kr_public/blob/master/rep/plt.py target=_blank>plt</a> : plotting core.</li></ul><p>Given a backtesting log produced by the trading bot, it will generate :</p><ul><li>one summary picture of the bot&rsquo;s top level behavior.</li><li>for each trade sequence, a summary picture of the decisions of the trade sequence.</li></ul><p>The examples found in this section are accompanied by archives containing :</p><ul><li>the backtesting logs.</li><li>the visual reports generated from the backtesting logs.</li></ul><p>In order to re-generate those visual reports from the logs, run :</p><pre tabindex=0><code>bot_rep.py prs &lt;log&gt; &lt;tmp&gt; &amp;&amp; bot_rep.py exp &lt;tmp&gt; &lt;report_path&gt; -r -s
</code></pre><p>with :</p><ul><li><code>log</code> : the log file.</li><li><code>tmp</code> : the path for the temporary parsed log blob (used by the tool internally).</li><li><code>rep</code> : the path to generate visual reports at. If you provide <code>/tmp/pict</code> it will generate <code>/tmp/pict_main.svg</code> for the toplevel view and <code>/tmp/pict_seq_&lt;N>.svg</code> for each sequence.</li></ul><h3 class="relative group">Self backtesting : aapl_aapl_1d<div id=self-backtesting--aapl_aapl_1d class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#self-backtesting--aapl_aapl_1d aria-label=Anchor>#</a></span></h3><p>A good way to test that the bot works is to have it backtest a symbol against a future version of itself : predicting the behavior of AAPL in one day knowing AAPL in one day is very reliable. If our bot mispredicts anything here, then it has a bug.</p><p>The backtesting report showed here was generated backtesting a single strategy predicting AAPL&rsquo;s next day behavior based on AAPL&rsquo;s next day values, from Jan 1st 2024 to March 1st 2024.</p><p>First, let&rsquo;s take a look at the high level report.</p><figure><img class="my-0 rounded-md" src=/briztal.github.io/images/bot/aapl_aapl_1d_main.svg alt="self bkt top"><figcaption>Self backtesting top level.</figcaption></figure><p>All graphs have the time as abscissa and various data in ordinate.</p><p>The first graph on top shows the two curves that the predictor operates on. We see two versions of the same curve, translated of a day, which aligns with what we expect.</p><p>The second graph in the middle shows :</p><ul><li>bottom curve : the number of AAPL stocks that the bot owns with time.</li><li>top curve : the amount of money ($) owned by the bot not involved in orders.</li></ul><p>The third graph on the bottom plots the two curves again, and adds a horizontal line covering the duration of each trade sequence. The line is green if the trade sequence was successfull (target price reached) or red if it was failed (target price not reached).
The ordinate of the trade sequence lines has no particular meaning apart from indicating the sequence creation order.
In this case, all sequences were successful.</p><p>Now, let&rsquo;s take a look at what trade sequence 25 did as an example.</p><figure><img class="my-0 rounded-md" src=/briztal.github.io/images/bot/aapl_aapl_1d_seq_25.svg alt="self bkt seq"><figcaption>Self backtesting trade sequence example.</figcaption></figure><p>In abscissa, compacted in a totally unreadable way thanks to mathplotlib (&lt;3) we have the time base expressed in <code>mid</code>.
Just above the time axis, there is a colored timeline where :</p><ul><li>the grey part represents the time before the trade sequence&rsquo;s creation. Our trading bot being relatively causal, all data used by the predictor should be in this area.</li><li>the green part represents the time window where buying is allowed.</li><li>the blue part represents the time window where monitoring is allowed.</li><li>the red part represents the time window where monitoring is not allowed anymore and assets should be sold. It occupies all the time range after the monitoring range.</li></ul><p>In ordinate, we have the prices, and the two curves that are drawn are :</p><ul><li>on the left, the curve used by the strategy to make its prediction, here it is AAPL+1d.</li><li>on the right, the curve used by the trade sequence to pass and monitor orders, here it is AAPL.</li></ul><p>Again, we can see that the two curves are identical modulus a translation.</p><p>The two red dots connected by a line are the two prices used by the strategy&rsquo;s predictor to make its prediction. The bot&rsquo;s behavior being correct, they coincide with the predictor&rsquo;s curve. If there was a bug in the predictor (read at the wrong time), they would differ.</p><p>The two blue dots represent :</p><ul><li>on the left : the price at which we bought our assets.</li><li>on the right : the price at which we sold our assets.</li></ul><p>Again, since the bot&rsquo;s behavior is correct, those dots belong to the curve used by the trade sequence.</p><p>There are also a set of indicator lines.</p><p>The horizontal lines represent :</p><ul><li>bottom black line : price at sequence construction.</li><li>middle blue line : limit price for buying.</li><li>top green line : target price for selling.</li></ul><p>The vertical lines represent :</p><ul><li>left green line : buy time.</li><li>right blue line : sell time.</li></ul><h3 class="relative group">No correlation : predict NVDA based on AAPL<div id=no-correlation--predict-nvda-based-on-aapl class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#no-correlation--predict-nvda-based-on-aapl aria-label=Anchor>#</a></span></h3><figure><img class="my-0 rounded-md" src=/briztal.github.io/images/bot/aapl_nvda_main.svg alt="non cor top"><figcaption>Backtesting a strategy correlating non-correlated curves.</figcaption></figure><p>What we see here is interesting : we ended up with a positive return on investment because the target instrument (NVDA) had a price increase in the backtesting period (it doubled in value).</p><p>We can hence see that even with faulty info, we can end up with a positive return just because our target was steadily increasing.</p><p>As we can see, regardless of when AAPL gained in value, the resulting trading sequence (trading NVDA) was able to consistently meet its target price, because NVDA was coincidentally increasing in price.</p><p>Let&rsquo;s see a case where it is not that simple : the inverse prediction.</p><h3 class="relative group">When it goes <em>bang</em> : predict AAPL based on NVDA<div id=when-it-goes-_bang_--predict-aapl-based-on-nvda class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#when-it-goes-_bang_--predict-aapl-based-on-nvda aria-label=Anchor>#</a></span></h3><figure><img class="my-0 rounded-md" src=/briztal.github.io/images/bot/nvda_aapl_main.svg alt="non cor top"><figcaption>Backtesting a strategy correlating non-correlated curves, predicting one that did not steadily gain value.</figcaption></figure><p>This time we see something totally different : AAPL did not steadily gain in price during the backtesting time, so the sudden price increases in NVDA had no particular reason to be related to sudden AAPL price increases.</p><p>All trade sequences except a couple of lucky one were unsuccessfull, and We even ended up loosing some money.</p><h2 class="relative group">Conclusion.<div id=conclusion class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#conclusion aria-label=Anchor>#</a></span></h2><p>This article finishes my series on the trading bot.</p><p>As I had stated in the introduction, the objective of this series was to describe the structure of my implementation, elaborate on the design choices, and show a couple of interesting problems, which I hope to have achieved.</p><p>As those last sections described, printing money is not easy, and the real value of the trading bot is its ability to make the best use of reliable predictions.</p><p>Establishing those predictions is a complete separate topic, on which I did not spend time yet and which I will probably not do so soon, as I am currently moving on to other projects.</p><p>I hope you had a pleasant reading.</p><p>This chapter elaborates on how the algorithm that passes orders given the prediction made by a strategy.</p><p>It will also serve as an opportunity to show the backtesting feature in action.</p><p>The implemented algorithm specializes in trading securities in a simple way, it buys a security, then attempts to sell it at a higher price.</p><p>While this appears simple, there are subtleties to understand and precautions to take when doing such a simple task.</p><p>Trading more complex instruments, or trading securities using different techniques would undoubtedly involve more complex trade sequences, but the constraints and objectives of this simple model would still apply.</p><h2 class="relative group">Abstract objectives<div id=abstract-objectives-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#abstract-objectives-1 aria-label=Anchor>#</a></span></h2><p>The trade sequence is the code block that given :</p><ul><li>an instrument;</li><li>a prediction on the future price of this instrument made by a strategy;</li><li>a given amount of money in the instrument&rsquo;s trading currency, determined by the allocator;
creates and manages orders to extract a profit from the prediction.</li></ul><p>Its order management algorithm must be precise and bug-free, as it must avoid at all costs :</p><ul><li>using more money than allowed by the allocator which would put the portfolio in a money deficit.</li><li>selling more units of the target instruments than the amount that it has previously bought which would put the portfolio in an asset deficit.</li><li>losing track of orders, which would make resources vanish from the portfolio.</li></ul><p>The last part has a subtlety implied by my design choices.</p><p>A look at the trading bot&rsquo;s high level diagram will show that the trade sequence is the bot&rsquo;s only entity that manages orders.</p><p>An implication of this is that if we aim at deleting a trade sequence, we must ensure that all its orders are either complete or cancelled.</p><p>The trading bot is regularly exported to allow fail safety, and stopping it does not cause a trade sequence deletion. It just means that when restarting the bot again, the trade sequence will be resumed, accounting for the same orders as before stopping the bot.</p><h2 class="relative group">Trade scenarios<div id=trade-scenarios-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#trade-scenarios-1 aria-label=Anchor>#</a></span></h2><p>The base algorithm of the trade sequence will be divided into three phases :</p><ul><li>buying : buy a certain number of units of the target instrument;</li><li>monitoring : wait for the target price to be reached;</li><li>selling : sell the bought units;</li></ul><p>This is very simple in theory, but there are subtleties that add to it.</p><p>Buying constraints :</p><ul><li>Buying can take time, and we do not want to buy if the price is already too high. Remember that we are low latency after all.</li><li>buying can take time and we do not want to buy after a certain time past the prediction. The prediction may be incorrect after all.</li><li>the prediction implies a future price increase, but if the price goes down, we may want to consider it unreliable and not buy.</li><li>the buy order may not be completely executed, and we may end up with less units than expected.</li></ul><p>Monitoring constraints :</p><ul><li>the prediction may be incorrect and the target price could not be reached in time. We must not wait indefinitely and just sell after some time.</li><li>the prediction may be incorrect and the price may decrease after buying. We must set a stop loss price and sell if it is reached.</li></ul><p>Selling is a critical part of the trade sequence as it is necessary for the trade sequence to be deletable. Hence, it should be as flexible as possible, and in practice, has no constraints. We just buy as many units as we have, with a market sell order.</p><h2 class="relative group">FSM<div id=fsm-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#fsm-1 aria-label=Anchor>#</a></span></h2><p>With the constraints listed so far, we can come up with a simple algorithm which behaves like an FSM.</p><p>It receives the following parameters :</p><ul><li><code>mny</code> : the amount of money to invest.</li><li><code>prc_buy</code> : the maximal buy price.</li><li><code>prc_tgt</code> : the target sell price.</li><li><code>prc_stp</code> : the minimal stop price.</li><li><code>buy_tim</code> : the maximum time allowed to buy.</li><li><code>mon_tim</code> : the maximum time allowed to monitor.</li></ul><p>Its states are :</p><ul><li>BUY : a single buy order for <code>mny</code> has been issued and we are waiting for its completion.<ul><li>If the order completes without cancellation, move to MON.</li><li>If the current price becomes lower than <code>prc_stp</code>, or if <code>buy_tim</code> has elapsed, cancel it and move to SEL, as the buy order may have been partially executed.</li></ul></li><li>MON : the buy order has been executed and we are monitoring the current price.<ul><li>If the price goes above <code>prc_tgt</code>, move to SEL (or to <code>TRG</code> if implemented, see the Improvements section below).</li><li>If the price goes below <code>prc_stp</code>, or if <code>mon_tim</code> has elapsed, move to SEL.</li></ul></li><li>SEL : the buy order has been executed, and the sell market order has been issued.<ul><li>If the sell order has been partially executed, re-issue one covering the remaining units.</li><li>If the sell order has been completely executed, move to DON.</li></ul></li><li>DON : all orders have been completed, ready for deletion.</li></ul><h2 class="relative group">Improvements<div id=improvements-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#improvements-1 aria-label=Anchor>#</a></span></h2><p>This section covers potential improvements to the trade sequence to increase profits or predictability.</p><p>Note that even those mechanisms may seem interesting per-se, they may not provide any benefit <em>without</em> <em>a</em> <em>valid</em> <em>prediction</em>.</p><p>They provide a benefit only because (should I say : <code>if</code>) the prediction itself has valid information. They do not provide information per-se. They <code>could</code> simply allow us to get closer to the predicted return by handling more corner cases in the market&rsquo;s behavior.</p><p>Their use and characteristics should be subject to backtesting, as they may be profitable or not based on the market conditions.</p><h3 class="relative group">1 : Sell only when the price decreases<div id=1--sell-only-when-the-price-decreases-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1--sell-only-when-the-price-decreases-1 aria-label=Anchor>#</a></span></h3><p>That will allow us to take advantage of a rising market.</p><p>The strategy&rsquo;s predictor only makes a prediction on the return between <code>now</code> and <code>now</code> + <code>some time</code>. It says nothing about what happens next, and if the price keeps going up, there is no reason for us to sell early.</p><p>To implement this, we need to establish a price drop percentage after which we sell.</p><h3 class="relative group">2 : divide the buy stage in multiple steps<div id=2--divide-the-buy-stage-in-multiple-steps-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2--divide-the-buy-stage-in-multiple-steps-1 aria-label=Anchor>#</a></span></h3><p>If the target instrument is volatile, it may be a good idea to not buy all units at the same time. On average this will not matter as we will have multiple trade sequences, which should average the volatility with time, but by handling this at the buy stage, we avoid propagating the volatility to the trade sequences performances, and be more predictable which matters to us.</p><h3 class="relative group">3 : add a TRG step between MON and SEL<div id=3--add-a-trg-step-between-mon-and-sel-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#3--add-a-trg-step-between-mon-and-sel-1 aria-label=Anchor>#</a></span></h3><p>If the target price has been reached, we try selling using a limit sell order for some time. If we could not sell all after this time, we enter the SEL stage and sell everything with a market order.</p><p>It allows us to only be affected by the positive side of volatility : if price temporarily goes down, we will not sell. If it goes up, we will sell at a better price.</p><p>The counterpart of this is that if the prices go down in a non-temporary manner, we will sell too late and at a potentially lesser price.</p><h2 class="relative group">Visual logs<div id=visual-logs-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#visual-logs-1 aria-label=Anchor>#</a></span></h2><p>For my testing I generated a lot of simulations to both test the bot&rsquo;s correctness and its ability to correctly (or not) take advantage of a prediction.</p><p>From the bot&rsquo;s logs, some nice graphs can be generated, to visually ensure that the bot&rsquo;s trade sequence does the right thing.</p><p>The python script that I wrote to generate the visual reports can be found <a href=https://github.com/Briztal/kr_public/blob/master/bot_rep.py target=_blank>here</a> and uses the <code>rep</code> package proviced <a href=https://github.com/Briztal/kr_public/blob/master/rep/ target=_blank>here</a> :</p><ul><li><a href=https://github.com/Briztal/kr_public/blob/master/rep/cmd.py target=_blank>cmd</a> : parsing utilities.</li><li><a href=https://github.com/Briztal/kr_public/blob/master/rep/rep.py target=_blank>rep</a> : report python structures.</li><li><a href=https://github.com/Briztal/kr_public/blob/master/rep/prs.py target=_blank>prs</a> : log parsing.</li><li><a href=https://github.com/Briztal/kr_public/blob/master/rep/plt.py target=_blank>plt</a> : plotting core.</li></ul><p>Given a backtesting log produced by the trading bot, it will generate :</p><ul><li>one summary picture of the bot&rsquo;s top level behavior.</li><li>for each trade sequence, a summary picture of the decisions of the trade sequence.</li></ul><p>The examples found in this section are accompanied by archives containing :</p><ul><li>the backtesting logs.</li><li>the visual reports generated from the backtesting logs.</li></ul><p>In order to re-generate those visual reports from the logs, run :</p><pre tabindex=0><code>bot_rep.py prs &lt;log&gt; &lt;tmp&gt; &amp;&amp; bot_rep.py exp &lt;tmp&gt; &lt;report_path&gt; -r -s
</code></pre><p>with :</p><ul><li><code>log</code> : the log file.</li><li><code>tmp</code> : the path for the temporary parsed log blob (used by the tool internally).</li><li><code>rep</code> : the path to generate visual reports at. If you provide <code>/tmp/pict</code> it will generate <code>/tmp/pict_main.svg</code> for the toplevel view and <code>/tmp/pict_seq_&lt;N>.svg</code> for each sequence.</li></ul><h3 class="relative group">Self backtesting : aapl_aapl_1d<div id=self-backtesting--aapl_aapl_1d-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#self-backtesting--aapl_aapl_1d-1 aria-label=Anchor>#</a></span></h3><p>A good way to test that the bot works is to have it backtest a symbol against a future version of itself : predicting the behavior of AAPL in one day knowing AAPL in one day is very reliable. If our bot mispredicts anything here, then it has a bug.</p><p>The backtesting report shown here was generated by backtesting a single strategy predicting AAPL&rsquo;s next day behavior based on AAPL&rsquo;s next day values, from Jan 1st 2024 to March 1st 2024.</p><p>First, let&rsquo;s take a look at the high level report.</p><figure><img class="my-0 rounded-md" src=/briztal.github.io/images/bot/aapl_aapl_1d_main.svg alt="self bkt top"><figcaption>Self backtesting top level.</figcaption></figure><p>All graphs have the time as abscissa and various data in ordinate.</p><p>The first graph on top shows the two curves that the predictor operates on. We see two versions of the same curve, translated of a day, which aligns with what we expect.</p><p>The second graph in the middle shows :</p><ul><li>bottom curve : the number of AAPL stocks that the bot owns with time.</li><li>top curve : the amount of money ($) owned by the bot not involved in orders.</li></ul><p>The third graph on the bottom plots the two curves again, and adds a horizontal line covering the duration of each trade sequence. The line is green if the trade sequence was successful (target price reached) or red if it was failed (target price not reached).
The ordinate of the trade sequence lines has no particular meaning apart from indicating the sequence creation order.
In this case, all sequences were successful.</p><p>Now, let&rsquo;s take a look at what trade sequence 25 did as an example.</p><figure><img class="my-0 rounded-md" src=/briztal.github.io/images/bot/aapl_aapl_1d_seq_25.svg alt="self bkt seq"><figcaption>Self backtesting trade sequence example.</figcaption></figure><p>In abscissa, compacted in a totally unreadable way thanks to matplotlib (&lt;3) we have the time base expressed in <code>mid</code>.
Just above the time axis, there is a colored timeline where :</p><ul><li>the grey part represents the time before the trade sequence&rsquo;s creation. Our trading bot being relatively causal, all data used by the predictor should be in this area.</li><li>the green part represents the time window where buying is allowed.</li><li>the blue part represents the time window where monitoring is allowed.</li><li>the red part represents the time window where monitoring is not allowed anymore and assets should be sold. It occupies all the time range after the monitoring range.</li></ul><p>In ordinate, we have the prices, and the two curves that are drawn are :</p><ul><li>on the left, the curve used by the strategy to make its prediction, here it is AAPL+1d.</li><li>on the right, the curve used by the trade sequence to pass and monitor orders, here it is AAPL.</li></ul><p>Again, we can see that the two curves are identical modulus translation.</p><p>The two red dots connected by a line are the two prices used by the strategy&rsquo;s predictor to make its prediction. The bot&rsquo;s behavior being correct, they coincide with the predictor&rsquo;s curve. If there was a bug in the predictor (read at the wrong time), they would differ.</p><p>The two blue dots represent :</p><ul><li>on the left : the price at which we bought our assets.</li><li>on the right : the price at which we sold our assets.</li></ul><p>Again, since the bot&rsquo;s behavior is correct, those dots belong to the curve used by the trade sequence.</p><p>There are also a set of indicator lines.</p><p>The horizontal lines represent :</p><ul><li>bottom black line : price at sequence construction.</li><li>middle blue line : limit price for buying.</li><li>top green line : target price for selling.</li></ul><p>The vertical lines represent :</p><ul><li>left green line : buy time.</li><li>right blue line : sell time.</li></ul><h3 class="relative group">No correlation : predict NVDA based on AAPL<div id=no-correlation--predict-nvda-based-on-aapl-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#no-correlation--predict-nvda-based-on-aapl-1 aria-label=Anchor>#</a></span></h3><figure><img class="my-0 rounded-md" src=/briztal.github.io/images/bot/aapl_nvda_main.svg alt="non cor top"><figcaption>Backtesting a strategy correlating non-correlated curves.</figcaption></figure><p>What we see here is interesting : we ended up with a positive return on investment because the target instrument (NVDA) had a price increase in the backtesting period (it doubled in value).</p><p>We can hence see that even with faulty info, we can end up with a positive return just because our target was steadily increasing.</p><p>As we can see, regardless of when AAPL gained in value, the resulting trading sequence (trading NVDA) was able to consistently meet its target price, because NVDA was coincidentally increasing in price.</p><p>Let&rsquo;s see a case where it is not that simple : the inverse prediction.</p><h3 class="relative group">When it goes <em>bang</em> : predict AAPL based on NVDA<div id=when-it-goes-_bang_--predict-aapl-based-on-nvda-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#when-it-goes-_bang_--predict-aapl-based-on-nvda-1 aria-label=Anchor>#</a></span></h3><figure><img class="my-0 rounded-md" src=/briztal.github.io/images/bot/nvda_aapl_main.svg alt="non cor top"><figcaption>Backtesting a strategy correlating non-correlated curves, predicting one that did not steadily gain value.</figcaption></figure><p>This time we see something totally different : AAPL did not steadily gain in price during the backtesting time, so the sudden price increases in NVDA had no particular reason to be related to sudden AAPL price increases.</p><p>All trade sequences except a couple of lucky ones were unsuccessful, and we even ended up losing money.</p><h2 class="relative group">Conclusion.<div id=conclusion-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#conclusion-1 aria-label=Anchor>#</a></span></h2><p>This article finishes my series on the trading bot.</p><p>As I had stated in the introduction, the objective of this series was to describe the structure of my implementation, elaborate on the design choices, and show a couple of interesting problems, which I hope to have achieved.</p><p>As those last sections described, printing money is not easy, and the real value of the trading bot is its ability to make the best use of reliable predictions.</p><p>Establishing those predictions is a completely separate topic, on which I did not spend time yet and which I will probably not do so soon, as I am currently moving on to other projects.</p><p>I hope you had a pleasant reading.</p></div><details style=margin-left:0 class="mt-2 mb-5 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5"><summary class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-primary-800 dark:text-neutral-100">Trading_bot - This article is part of a series.</summary><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=briztal.github.io/projects/bot/bot_0_intro/>Part 0: Trading bot : introduction</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=briztal.github.io/projects/bot/bot_1_top/>Part 1: Trading core : high level view</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=briztal.github.io/projects/bot/bot_2_prv/>Part 2: Trading bot : data provider.</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">Part 3: This Article</div></details></div><script>var oid="views_projects/bot/bot_3_seq.md",oid_likes="likes_projects/bot/bot_3_seq.md"</script><script type=text/javascript src=/briztal.github.io/js/page.min.b06a29d42a4ed16787978e2eee1e8c797b7698db2bc14ccee78f5c80ac566fc996190a73ad80a5e987558474b20b96fa38f7d85b405f165ff72b7b163c5ad11b.js integrity="sha512-sGop1CpO0WeHl44u7h6MeXt2mNsrwUzO549cgKxWb8mWGQpzrYCl6YdVhHSyC5b6OPfYW0BfFl/3K3sWPFrRGw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=briztal.github.io/projects/bot/bot_2_prv/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Trading bot : data provider.</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-06-19T00:00:00+00:00>19 June 2025</time></span></span></a></span>
<span><a class="flex text-right group ml-3" href=briztal.github.io/projects/jsn/jsn_0_intro/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">TurboJSON : JSON basics.</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-07-30T00:00:00+00:00>30 July 2025</time></span></span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/briztal.github.io/js/process.min.62060bb247f4de2b6dde45903668fefb68d792f365587605177b1227c0cf43588701edaca0cb40e2c8e2789bd5ce67c1d2a215b9fb258c3496a7cd25e7cb5fdf.js integrity="sha512-YgYLskf03itt3kWQNmj++2jXkvNlWHYFF3sSJ8DPQ1iHAe2soMtA4sjieJvVzmfB0qIVufsljDSWp80l58tf3w=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=briztal.github.io style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>