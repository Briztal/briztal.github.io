<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Memory Manager : Primary allocators. &#183;</title><meta name=title content="Memory Manager : Primary allocators. &#183; "><meta name=description content="The primary memory manager"><link rel=canonical href=briztal.github.io/projects/memory_management/mm_1/><link type=text/css rel=stylesheet href=/briztal.github.io/css/main.bundle.min.29653ed199b7a749016920bb9715d240156e67049c90f12ffede5bb7f952606ecd8b0dd0c3f01d75af648960eddb25a879915d6e24858a75d11d9eed0607d9c6.css integrity="sha512-KWU+0Zm3p0kBaSC7lxXSQBVuZwSckPEv/t5bt/lSYG7Niw3Qw/Adda9kiWDt2yWoeZFdbiSFinXRHZ7tBgfZxg=="><script type=text/javascript src=/briztal.github.io/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script>
<script defer type=text/javascript id=script-bundle src=/briztal.github.io/js/main.bundle.min.5155d528b5217d2be660e88e103a0553710d2c94c85e3221100642905f3e6cbbb67b3760a44ab4f36703f12fbfe1d6f5b4545c3ae3a3f34784d919904ab7f1d7.js integrity="sha512-UVXVKLUhfSvmYOiOEDoFU3ENLJTIXjIhEAZCkF8+bLu2ezdgpEq082cD8S+/4db1tFRcOuOj80eE2RmQSrfx1w==" data-copy=Copy data-copied=Copied></script>
<script src=/briztal.github.io/lib/zoom/zoom.min.f592a181a15d2a5b042daa7f746c3721acf9063f8b6acd175d989129865a37d400ae0e85b640f9ad42cd98d1f8ad30931718cf8811abdcc5fcb264400d1a2b0c.js integrity="sha512-9ZKhgaFdKlsELap/dGw3Iaz5Bj+Las0XXZiRKYZaN9QArg6FtkD5rULNmNH4rTCTFxjPiBGr3MX8smRADRorDA=="></script>
<link rel=apple-touch-icon sizes=180x180 href=/briztal.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/briztal.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/briztal.github.io/favicon-16x16.png><link rel=manifest href=/briztal.github.io/site.webmanifest><meta property="og:title" content="Memory Manager : Primary allocators."><meta property="og:description" content="The primary memory manager"><meta property="og:type" content="article"><meta property="og:url" content="briztal.github.io/projects/memory_management/mm_1/"><meta property="article:section" content="projects"><meta property="article:published_time" content="2021-09-19T00:00:00+00:00"><meta property="article:modified_time" content="2021-09-19T00:00:00+00:00"><meta property="og:see_also" content="briztal.github.io/projects/memory_management/mm_0_into/"><meta name=twitter:card content="summary"><meta name=twitter:title content="Memory Manager : Primary allocators."><meta name=twitter:description content="The primary memory manager"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Personal Projects","name":"Memory Manager : Primary allocators.","headline":"Memory Manager : Primary allocators.","abstract":"The primary memory manager","inLanguage":"en","url":"briztal.github.io\/projects\/memory_management\/mm_1\/","author":{"@type":"Person","name":""},"copyrightYear":"2021","dateCreated":"2021-09-19T00:00:00\u002b00:00","datePublished":"2021-09-19T00:00:00\u002b00:00","dateModified":"2021-09-19T00:00:00\u002b00:00","mainEntityOfPage":"true","wordCount":"2530"}]</script><script src=/briztal.github.io/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script>
<link type=text/css rel=stylesheet href=/briztal.github.io/lib/katex/katex.min.7e7e35e3ef02b7b437449a44ca3fac62ec1ed39cb8312b680a00fe8ac60badc95b063b694636b8440856f7f5e8c2cc9e6b0efb581179b2656c7e1e97558c7096.css integrity="sha512-fn414+8Ct7Q3RJpEyj+sYuwe05y4MStoCgD+isYLrclbBjtpRja4RAhW9/Xowsyeaw77WBF5smVsfh6XVYxwlg=="><script defer src=/briztal.github.io/lib/katex/katex.min.cadd45c1af1f44bdaf196dc9b104f1daeb29043f0dc59155ffe22847510a04390a0b7a859400d420a626204f7fc5ddb07c19311de1c66b25e19c2559d3e126a8.js integrity="sha512-yt1Fwa8fRL2vGW3JsQTx2uspBD8NxZFV/+IoR1EKBDkKC3qFlADUIKYmIE9/xd2wfBkxHeHGayXhnCVZ0+EmqA=="></script>
<script defer src=/briztal.github.io/lib/katex/auto-render.min.e9b2833d28623d18c071d78ef13e9c79d695122d296af3dbcee7bf1bf6518b0565bab59939267fbc8f5faf696193c20f5caef3e7501969cfb306f6738032730d.js integrity="sha512-6bKDPShiPRjAcdeO8T6cedaVEi0pavPbzue/G/ZRiwVlurWZOSZ/vI9fr2lhk8IPXK7z51AZac+zBvZzgDJzDQ==" onload=renderMathInElement(document.body)></script><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/briztal.github.io class="text-base font-medium text-gray-500 hover:text-gray-900"></a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=briztal.github.io/projects/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title="Personal Projects">Projects</p></a><a href=briztal.github.io/about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title="About me">About</p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-1 rtl:ml-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><label id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=briztal.github.io/projects/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title="Personal Projects">Projects</p></a></li><li class=mt-1><a href=briztal.github.io/about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title="About me">About</p></a></li></ul></div></label></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Memory Manager : Primary allocators.</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2021-09-19T00:00:00+00:00>19 September 2021</time></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("briztal.github.io/categories/kernel/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kernel</span></span></span>
<span style=margin-top:.5rem class=mr-2 onclick='return window.open("briztal.github.io/categories/memory-management/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Memory Management</span></span></span>
<span style=margin-top:.5rem class=mr-2 onclick='return window.open("briztal.github.io/categories/c/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">C</span></span></span>
<span style=margin-top:.5rem class=mr-2 onclick='return window.open("briztal.github.io/categories/operating-systems/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Operating Systems</span></span></span></div></div><div class="flex author"><div class=place-self-center><div class="text-2xl sm:text-lg"></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#dma-and-the-need-for-memory-zones>DMA and the need for memory zones</a></li><li><a href=#numa-and-the-need-for-a-memory-manager-per-node>NUMA and the need for a memory manager per node</a></li><li><a href=#numa-fallback>NUMA Fallback</a></li><li><a href=#primary-memory-dispatch>Primary memory dispatch</a></li><li><a href=#page-cache>Page cache</a></li><li><a href=#primary-memory-allocator--the-buddy-allocator>Primary memory allocator : the buddy allocator</a></li><li><a href=#secondary-allocation>Secondary allocation</a></li><li><a href=#memory-manager-architecture>Memory manager architecture</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#dma-and-the-need-for-memory-zones>DMA and the need for memory zones</a></li><li><a href=#numa-and-the-need-for-a-memory-manager-per-node>NUMA and the need for a memory manager per node</a></li><li><a href=#numa-fallback>NUMA Fallback</a></li><li><a href=#primary-memory-dispatch>Primary memory dispatch</a></li><li><a href=#page-cache>Page cache</a></li><li><a href=#primary-memory-allocator--the-buddy-allocator>Primary memory allocator : the buddy allocator</a></li><li><a href=#secondary-allocation>Secondary allocation</a></li><li><a href=#memory-manager-architecture>Memory manager architecture</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></details><script></script></div></div><div class="min-w-0 min-h-0 max-w-fit"><details style=margin-left:0 class="mt-2 mb-5 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5" open><summary class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-primary-800 dark:text-neutral-100">Memory Management - This article is part of a series.</summary></details><div class="article-content max-w-prose mb-20"><h2 class="relative group">Introduction<div id=introduction class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#introduction aria-label=Anchor>#</a></span></h2><p>In the previous chapter we defined the base characteristics of the system managed by a memory manager. Additionally, we also defined the primary memory manager as the sub-system of the memory manager responsible for :</p><ul><li><strong>referencing</strong> primary memory blocks.</li><li><strong>allocating page blocks</strong> in these primary memory blocks.</li></ul><p>The primary memory manager’s allocation system is required to :</p><ul><li>be <strong>stand alone</strong> and not depend on any external allocator to store it’s allocation metadata.</li><li>support both <strong>allocation</strong> and <strong>free</strong>.</li><li><strong>avoid internal fragmentation</strong>, i.e. allocate more memory than needed.</li><li><strong>avoid external fragmentation</strong>, i.e. coalesce contiguous free regions when possible.</li></ul><p>This chapter aims to complexify and provide a more detailed look at the system the primary manager has to work in by introducing the concept of memory zone, as well as developing the previously introduced concept of memory node.</p><p>Then, we will present the base algorithm for managing the primary memory for a single zone of a single node.</p><p>Finally, we will conclude by a detailed diagram summarising the memory manager’s architecture.</p><figure><img class="my-0 rounded-md" src=/briztal.github.io/images/memory_management/ram.webp alt><figcaption>Credits : Photo by Hanisch from FreeImages</figcaption></figure><h2 class="relative group">DMA and the need for memory zones<div id=dma-and-the-need-for-memory-zones class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#dma-and-the-need-for-memory-zones aria-label=Anchor>#</a></span></h2><p>In the first chapter we described physical memory as an uniform resource with no other differentiating characteristics apart from it the NUMA node dimension. This was an oversimplification, and in order to better explain how things really work we need to introduce the concept of Direct Memory Access.</p><p>Some peripherals like UART may rely exclusively on memory-mapped registers to receive or send data to and from the operating system. In these cases, they may have a small internal buffer accessible through these memory mapped registers, that the OS must periodically read/write to.</p><p>This read/write sequence is often executed in an interrupt sequence, triggered by the device when it has transmitted or received data.</p><p>Though this sequence may be suitable for embedded systems where the relative temporal cost of an interrupt is not that high (note to the reader : I am not saying the cost is low), with low bandwidth devices that do not force the OS to permanently poll the device, it clearly shows its limits in modern systems where the cost of an interrupt is non-neglectable, or with devices with a higher bandwidth.</p><p>To solve this issue, communication peripherals now present Direct Memory Access (DMA) capabilities that give them the means to directly read/write the data they receive/send to memory.</p><p>Their memory operations are done in physical address space, they directly (or indirectly in the presence of an IOMMU, which we will not go into as this is out of the scope of our topic) access the physical address space.</p><p>The Operating System has to allocate primary memory buffers that these devices can use, and notify them that they must read/write to those buffers.</p><p>The device now has the liberty to schedule its reads/writes depending on its own constraints, and will only wake up the OS when it needs new buffers.</p><p>But this raises an issue though : the physical address space may be a 64 bits address space, and some devices may not support it : their accessible addresses will be 16 or 32 bits long. The OS nowhas to ensure that primary memory allocated for peripheral DMA is effectively in the target periperal’s accessible address range.</p><p>For this reason (there are other use cases, for example Linux’s HIGHMEM zone), the concept of memory zone emerged. It simply consists of considering not one homogeneous set of primary memory blocks, but rather considering multiple sets, or zones, each one containing memory suited for one type of usage.</p><p>Linux systems generally exhibit the following zones :</p><ul><li>DMA16 : primary memory with 16 bits addresses.</li><li>DMA32 : primary memory with 32 bits addresses.</li><li>NORMAL : primary memory used by regular software.</li><li>HIGHMEM : primary memory that cannot be permanently mapped in kernel space.</li></ul><p>Each zone will have its own primary memory allocator.</p><p>Additional details :</p><ul><li><a href="https://www.kernel.org/doc/gorman/html/understand/understand005.html?source=post_page-----4f7c6f341f38---------------------------------------" target=_blank>Describing Physical Memory | The Linux Kernel documentation</a></li></ul><p>Exploring the HIGHMEM concept :
ndocumentation</p><ul><li><a href="https://unix.stackexchange.com/questions/4929/what-are-high-memory-and-low-memory-on-linux?source=post_page-----4f7c6f341f38---------------------------------------" target=_blank>What are high memory and low memory on Linux? | Unix Stack Exchange</a></li><li><a href="https://lwn.net/Articles/813201/?source=post_page-----4f7c6f341f38---------------------------------------" target=_blank>An end to high memory? | lwn.net</a></li></ul><h2 class="relative group">NUMA and the need for a memory manager per node<div id=numa-and-the-need-for-a-memory-manager-per-node class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#numa-and-the-need-for-a-memory-manager-per-node aria-label=Anchor>#</a></span></h2><p>As defined in the previous chapter, a node is a conceptual set containing memory banks and cores. The respective nodes of a core and a memory bank are the only information the OS uses to determine the latency of the access from a core to the memory bank.</p><p>This latency information is fundamental for the primary memory manager, as its role is to provide memory to all different cores. Its objective will be to provide to each core primary memory that will be optimized for the smallest access latency. All whilst respecting external constraints such as the zone the primary memory must be part of.</p><p>To achieve this, the memory manager must be decentralised, and each node will have its own memory manager.</p><p>This node memory manager will have a set of zones, and each zone will have it’s own primary memory allocator. Each core will know the node it belongs to, and so, will query the related node’s manager for allocation / deallocation of primary memory. The node manager will then transfer the request to the primary memory allocator of the related zone.</p><p>More details on NUMA :</p><ul><li><a href="https://www.kernel.org/doc/html/v5.0/vm/numa.html?source=post_page-----4f7c6f341f38---------------------------------------" target=_blank>What is NUMA | The Linux Kernel documentation</a></li><li><a href="https://en.wikipedia.org/wiki/Non-uniform_memory_access?source=post_page-----4f7c6f341f38---------------------------------------" target=_blank>Non-uniform memory access | Wikipedia</a></li><li><a href="https://linuxhint.com/understanding_numa_architecture/?source=post_page-----4f7c6f341f38---------------------------------------" target=_blank>Understanding NUMA Architecture</a></li></ul><h2 class="relative group">NUMA Fallback<div id=numa-fallback class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#numa-fallback aria-label=Anchor>#</a></span></h2><p>The procedure described in the previous paragraph raises the question : what if the selected zone allocator runs out of memory ?</p><p>One of the constraints of the NUMA system that we have described was that each core in the system could access each memory bank. Only the access latency varies.</p><p>Following this constraint, all the allocator has to do is to select a compatible fallback zone allocator and forward the allocation request to it.</p><p>This fallback zone could be determined at allocation time, but, as the constraints that would help guide this choice are entirely known at compile-time, this might not result in the most optimized solution. As you might already have guessed, these constraints are :</p><ul><li>memory latency, purely node-dependent.</li><li>zone compatibility, known by design : DMA16 should be compatible with DMA32, DMA32 with NORMAL etc…</li></ul><p>As a consequence, it is possible to define this zone that the fallback allocator should use both at startup or compile-time.</p><p>Linux, for example, keeps for each zone of each node a constant array of fallback zones references, that can be used when the zone’s allocator runs out of memory.</p><p>Problems really arise when all of these fallback zones also run out of memory. We are left in a bind as the memory manager cannot invent memory : if all of our allocators end up starving, the system should crash, at least in a controlled way.</p><figure><img class="my-0 rounded-md" src=/briztal.github.io/images/memory_management/plane.webp alt><figcaption>Controlled emergency landing : JetBlue Flight 292 makes an emergency landing at Los Angeles International Airport.</figcaption></figure><p>Additional details ( if you dare ):</p><ul><li><a href="https://elixir.bootlin.com/linux/latest/source/include/linux/mmzone.h?source=post_page-----4f7c6f341f38---------------------------------------#L490" target=_blank>mmzone.h - include/linux/mmzone.h - Linux source code (v5.14.6) | Bootlin</a></li><li><a href="https://elixir.bootlin.com/linux/v4.6/source/include/linux/mm_types.h?source=post_page-----4f7c6f341f38---------------------------------------" target=_blank>mm_types.h - include/linux/mm_types.h - Linux source code (v4.6) | Bootlin</a></li></ul><h2 class="relative group">Primary memory dispatch<div id=primary-memory-dispatch class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#primary-memory-dispatch aria-label=Anchor>#</a></span></h2><p>When the system boots, primary memory blocks positions and sizes are either :</p><ul><li>Read in a static descriptor of some sort (static memory block boundaries, device tree, …).</li><li>Provided by a host or hypervisor.</li></ul><p>The node itself doesn’t impose constraints on the location of its primary memory, only the zone may impose such constraints.</p><p>The memory manager must then forward it to the primary allocator of the zone that manages it, either by :</p><ul><li>explicit request when the zones don’t have position constraints</li><li>by address calculation otherwise</li></ul><p>Anyway, the zone primary memory allocator only ends up with blocks of memory that concern it.</p><h2 class="relative group">Page cache<div id=page-cache class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#page-cache aria-label=Anchor>#</a></span></h2><p>Pages are the base granule for address space mapping. When a process requires any type of memory (stack, heap, file mapping, memory mapping), it calls the kernel so that the latter can allocate it the required number of pages and then configure the virtual address space to map a contiguous block of virtual memory to these allocated pages.</p><p><em>Note : pages being an important resource, the OS may adopt different strategies to reduce unnecessary page consumption, one of them being deferred allocation : the OS will at first allocate a block in the user’s virtual address space but map it to nothing. Later, when the user accesses this unmapped memory, it causes a translation fault. At this moment, the OS will allocate pages for this accessed location and effectively do the mapping. This allows the OS to allocate pages only if they are used. To illustrate how useful this is, we take the example of a user requiring 256 MiB of memory and not accessing it afterwards. With such a system in place, we have simply prevented any wasteful page allocations and saved ourselves 256MiB of memory.</em></p><p>If a page is used by a core, because of how the core’s cache system exploits temporal and spatial memory locality, it is likely that it already has some content of this page in cache. Once this page is freed for any reason, subsequent allocations in this core have a significant advantage in reusing this page. Otherwise, the cache system’s replacement policy will move in new cache lines and discard unused ones, but, there is a possibility this might not immediately concern the recently freed page. Reciprocally, a different core would have little interest to use this page given the choice, as it would cause the related cache lines to be shared among caches of those cores.</p><p>As a consequence, it may be interesting for the memory manager to implement a per-core page cache sorting pages by recency to exploit this temporal locality to its fullest : a core requiring a page now looks into its page cache and if empty, allocates a page using its node’s allocator. When the core frees a page, it puts it in its cache for future reuse, and eventually frees the oldest page in cache if the cache is full.</p><h2 class="relative group">Primary memory allocator : the buddy allocator<div id=primary-memory-allocator--the-buddy-allocator class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#primary-memory-allocator--the-buddy-allocator aria-label=Anchor>#</a></span></h2><p>Now that we have described in detail the objectives of the primary memory allocator, let us give a more practical example with a description of one of its possible and most widely known implementations : the buddy allocator.</p><p>To solve the primary memory allocation / free problem efficiently, we will first add two constraints :</p><ul><li>the allocator must only support allocation and free of page blocks containing a number of pages that are a power of two. This is the core characteristic of the buddy allocator algorithm.</li><li>the size of the block must be provided at both allocation <code>(void *alloc(size_t size))</code> and free <code>(void free(void *ptr, size_t size))</code>. This will avoid the need to store block sizes alongside the block as metadata.</li></ul><p>A solution to this problem with these constraints is provided by the well known Buddy Allocator algorithm.</p><p>This implementation is the one used by linux, among others.</p><p>As the Buddy Allocator has already been very well described in many other articles, as such, I will only briefly describe its working principles and provide adequate references as to where to find more detailed explanations.</p><p>The main working principles behind this algorithm is to :</p><ul><li>define valid blocks as blocks of size \(2^i\) page, aligned with their own size.</li><li>observe that given a block with two neighbours of its own size, there is only one other block that it can be merged with to form a valid block of the closest greater size. We call this block its ‘buddy’.</li><li>reference valid free blocks by order \(log2(size)\) in a cache, i.e. a linked list array : the list at index i references valid free blocks of size \(2^{(i + page order)}\). Free blocks are used to contain their own metadata, including the linked list node that references them.</li><li>When a new primary memory block is received, divide it into a set of valid free blocks, as big as possible, and reference these blocks in the cache.</li></ul><p>If a the allocation of a block of size \(2^i\) pages is required :</p><ul><li>If a valid free block of this size is available, use it.</li><li>Otherwise, if a valid free block of size \(2^j\), (j > i) is available, split it into a set of smaller valid free blocks, of which a valid free block of the required size, use this block and reference other sub-blocks in the cache.</li><li>Otherwise, the allocation fails.</li></ul><p>If the free of a valid block of size \(2^i\) is required :</p><ul><li>If its buddy is free, merge them and reiterate with the resulting valid block.</li><li>insert the resulting block in the cache.</li></ul><p>The status (allocated / free) of a block’s neighbours can be obtained easily with no dynamic metadata
by using a bitmap containing for each valid block, the status of the block (free, allocated).
The size of this bitmap depends only on the number of pages \(N\) of the primary memory block \(N\) pages, \(N/2\) valid couples,
\(N/4\) valid quadruples, etc…), and its allocation is not a problem, as the primary memory block can have its
end truncated to contain it without causing an alignment (and so external fragmentation) problem for the
remaining area (it would be the case if the bitmap was put on the start of the primary block).</p><p>Documentation :</p><ul><li><a href="https://www.halolinux.us/kernel-reference/the-buddy-system-algorithm.html?source=post_page-----4f7c6f341f38---------------------------------------" target=_blank>The Buddy System Algorithm | Linux Kernel Reference</a></li><li><a href="https://en.wikipedia.org/wiki/Buddy_memory_allocation?source=post_page-----4f7c6f341f38---------------------------------------" target=_blank>Buddy memory allocation | Wikipedia</a></li></ul><h2 class="relative group">Secondary allocation<div id=secondary-allocation class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#secondary-allocation aria-label=Anchor>#</a></span></h2><p>Though the detailed overview of secondary allocation algorithms is reserved for further chapters, it is necessary to mention it here to better understand where it fit’s in the whole memory manager.</p><p>Whereas the primary memory allocator is in charge of the allocation of pages and larger blocks, the secondary allocators handle the allocation of small and intermediate blocks. This secondary allocator will use memory provided by the primary memory manager. This secondary allocator is node-centric : each node will have a secondary allocator using the node’s NORMAL zone as a superblock provider.</p><h2 class="relative group">Memory manager architecture<div id=memory-manager-architecture class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#memory-manager-architecture aria-label=Anchor>#</a></span></h2><p>The architecture that we described in this chapter is summarised in the following diagram with an example.</p><figure><img class="my-0 rounded-md" src=/briztal.github.io/images/memory_management/ugly_diagram.webp alt><figcaption>Representation of a simple memory manager system including both a primary and secondary allocator.</figcaption></figure><p>The example consists of a system with 4 cores and two nodes, cores 0 and 1 belonging to node 0, core 2 and 3 belonging to node 1.</p><p>Each node has three memory zones, DMA16, DMA32 and NORMAL.</p><p>Only the NORMAL zone of the node 0 has fallback zones, namely DMA32 and NORMAL zones from the node 1.</p><p>Each zone has its own primary memory allocator.</p><p>Each none has its own secondary allocator, using primary memory provided by the node’s NORMAL zone.</p><p>Each core uses the primary memory provided by its node, which forwards the allocation request to the required zone.</p><h2 class="relative group">Conclusion<div id=conclusion class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#conclusion aria-label=Anchor>#</a></span></h2><p>After this chapter, we have provided both a high-level view of a memory manager supporting the constraints of the system we defined, and a presentation of one of the most known primary memory allocation algorithms.</p><p>The next chapter will focus on the problems and algorithms involved in secondary memory management, thus achieving the overview of the memory manager.</p></div><details style=margin-left:0 class="mt-2 mb-5 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5"><summary class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-primary-800 dark:text-neutral-100">Memory Management - This article is part of a series.</summary></details></div><script>var oid="views_projects/memory_management/mm_1.md",oid_likes="likes_projects/memory_management/mm_1.md"</script><script type=text/javascript src=/briztal.github.io/js/page.min.b06a29d42a4ed16787978e2eee1e8c797b7698db2bc14ccee78f5c80ac566fc996190a73ad80a5e987558474b20b96fa38f7d85b405f165ff72b7b163c5ad11b.js integrity="sha512-sGop1CpO0WeHl44u7h6MeXt2mNsrwUzO549cgKxWb8mWGQpzrYCl6YdVhHSyC5b6OPfYW0BfFl/3K3sWPFrRGw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=briztal.github.io/projects/memory_management/mm_0_into/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Memory Managers : Introduction.</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2021-09-17T00:00:00+00:00>17 September 2021</time></span></span></a></span>
<span><a class="flex text-right group ml-3" href=briztal.github.io/projects/kernel_to_wasm_p1/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Joys of porting a kernel to WebAssembly, Part 1.</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2021-10-07T00:00:00+00:00>7 October 2021</time></span></span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/briztal.github.io/js/process.min.62060bb247f4de2b6dde45903668fefb68d792f365587605177b1227c0cf43588701edaca0cb40e2c8e2789bd5ce67c1d2a215b9fb258c3496a7cd25e7cb5fdf.js integrity="sha512-YgYLskf03itt3kWQNmj++2jXkvNlWHYFF3sSJ8DPQ1iHAe2soMtA4sjieJvVzmfB0qIVufsljDSWp80l58tf3w=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=briztal.github.io style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>