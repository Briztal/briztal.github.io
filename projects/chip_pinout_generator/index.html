<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Chip pinout generator &#183;</title><meta name=title content="Chip pinout generator &#183; "><meta name=description content="A non-smart but efficient way of connecting your PCBs."><link rel=canonical href=briztal.github.io/projects/chip_pinout_generator/><link type=text/css rel=stylesheet href=/briztal.github.io/css/main.bundle.min.29653ed199b7a749016920bb9715d240156e67049c90f12ffede5bb7f952606ecd8b0dd0c3f01d75af648960eddb25a879915d6e24858a75d11d9eed0607d9c6.css integrity="sha512-KWU+0Zm3p0kBaSC7lxXSQBVuZwSckPEv/t5bt/lSYG7Niw3Qw/Adda9kiWDt2yWoeZFdbiSFinXRHZ7tBgfZxg=="><script type=text/javascript src=/briztal.github.io/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script>
<script defer type=text/javascript id=script-bundle src=/briztal.github.io/js/main.bundle.min.5155d528b5217d2be660e88e103a0553710d2c94c85e3221100642905f3e6cbbb67b3760a44ab4f36703f12fbfe1d6f5b4545c3ae3a3f34784d919904ab7f1d7.js integrity="sha512-UVXVKLUhfSvmYOiOEDoFU3ENLJTIXjIhEAZCkF8+bLu2ezdgpEq082cD8S+/4db1tFRcOuOj80eE2RmQSrfx1w==" data-copy=Copy data-copied=Copied></script>
<script src=/briztal.github.io/lib/zoom/zoom.min.f592a181a15d2a5b042daa7f746c3721acf9063f8b6acd175d989129865a37d400ae0e85b640f9ad42cd98d1f8ad30931718cf8811abdcc5fcb264400d1a2b0c.js integrity="sha512-9ZKhgaFdKlsELap/dGw3Iaz5Bj+Las0XXZiRKYZaN9QArg6FtkD5rULNmNH4rTCTFxjPiBGr3MX8smRADRorDA=="></script>
<link rel=apple-touch-icon sizes=180x180 href=/briztal.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/briztal.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/briztal.github.io/favicon-16x16.png><link rel=manifest href=/briztal.github.io/site.webmanifest><meta property="og:title" content="Chip pinout generator"><meta property="og:description" content="A non-smart but efficient way of connecting your PCBs."><meta property="og:type" content="article"><meta property="og:url" content="briztal.github.io/projects/chip_pinout_generator/"><meta property="article:section" content="projects"><meta property="article:published_time" content="2024-01-01T00:00:00+00:00"><meta property="article:modified_time" content="2024-01-01T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Chip pinout generator"><meta name=twitter:description content="A non-smart but efficient way of connecting your PCBs."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Personal Projects","name":"Chip pinout generator","headline":"Chip pinout generator","abstract":"A non-smart but efficient way of connecting your PCBs.","inLanguage":"en","url":"briztal.github.io\/projects\/chip_pinout_generator\/","author":{"@type":"Person","name":""},"copyrightYear":"2024","dateCreated":"2024-01-01T00:00:00\u002b00:00","datePublished":"2024-01-01T00:00:00\u002b00:00","dateModified":"2024-01-01T00:00:00\u002b00:00","mainEntityOfPage":"true","wordCount":"2677"}]</script><script src=/briztal.github.io/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/briztal.github.io class="text-base font-medium text-gray-500 hover:text-gray-900"></a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=briztal.github.io/projects/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title="Personal Projects">Projects</p></a><a href=briztal.github.io/about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title="About me">About</p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-1 rtl:ml-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><label id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=briztal.github.io/projects/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title="Personal Projects">Projects</p></a></li><li class=mt-1><a href=briztal.github.io/about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title="About me">About</p></a></li></ul></div></label></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Chip pinout generator</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2024-01-01T00:00:00+00:00>1 January 2024</time></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("briztal.github.io/categories/c/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">C</span></span></span>
<span style=margin-top:.5rem class=mr-2 onclick='return window.open("briztal.github.io/categories/kicad/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">KiCAD</span></span></span></div></div><div class="flex author"><div class=place-self-center><div class="text-2xl sm:text-lg"></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#context>Context</a></li><li><a href=#pin-multiplexing>Pin multiplexing</a></li><li><a href=#the-problem>The problem</a></li><li><a href=#objective>Objective</a></li><li><a href=#the-expected-output>The expected output</a></li><li><a href=#numerical-complexity>Numerical complexity</a></li><li><a href=#algorithmic-data-structures>Algorithmic data structures</a></li><li><a href=#peripheral-types>Peripheral types</a></li><li><a href=#signals-optimizations>Signals optimizations</a></li><li><a href=#signals-optimizations-1>Signals optimizations</a></li><li><a href=#pathological-case>Pathological case</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#context>Context</a></li><li><a href=#pin-multiplexing>Pin multiplexing</a></li><li><a href=#the-problem>The problem</a></li><li><a href=#objective>Objective</a></li><li><a href=#the-expected-output>The expected output</a></li><li><a href=#numerical-complexity>Numerical complexity</a></li><li><a href=#algorithmic-data-structures>Algorithmic data structures</a></li><li><a href=#peripheral-types>Peripheral types</a></li><li><a href=#signals-optimizations>Signals optimizations</a></li><li><a href=#signals-optimizations-1>Signals optimizations</a></li><li><a href=#pathological-case>Pathological case</a></li></ul></nav></div></details><script></script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><h2 class="relative group">Context<div id=context class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#context aria-label=Anchor>#</a></span></h2><p>In April 2023 my wonderful wife had the best birthday idea ever, and made me a custom development board based on an STM32H7 MCU.</p><p>The chip was rather cool and had an USB connector, an SD-card interface, and a JLink connector. It was all I needed at the time.</p><p>As it was my first time selecting a processor, I just cared about the CPU architecture, presence of caches, and clock frequency. I didn&rsquo;t request a large flash or RAM size.</p><p>This detail ended up causing me some troubles, as I &ldquo;quickly&rdquo; (in a few months of adding code and developing a Kasan that needed a lot more code) filled the 128KiB of builtin Flash.</p><p>I then decided to upgrade the CPU, and since new capabilities are never worth nothing, I attempted to design the devboard V2 myself.</p><p>During this year of development, I also had written a custom USB stack and a driver to support ST&rsquo;s USB implementation.
And if it doesn&rsquo;t sound hard, trust me, it is. ST&rsquo;s USB module is the biggest pile of hardware crap I ever encountered. It had it all. Undocumented registers, hardware xprop, sudden freezes for no reasons, almost undocumented HW capabilities, pseudo-documented capabilities that aren&rsquo;t actually implemented, name it and it had it.
I bumped my head on the wall so much during the month and a half where I wrote that code, that the noise still resonates in the place that my now liquified brains used to occupy.</p><p>But that&rsquo;s another story.</p><p>An USB stack I had, and I wanted to experiment with it. More precisely, I wanted to try using an USB-C connector instead of my old USB-B, and also wanted to give High Speed USB a try, because ST&rsquo;s Full Speed USB wasn&rsquo;t painfully broken enough.</p><p>I also wanted to try and support the Ethernet, since there could be a lot more fun places where ST could fuck up, so why not visiting them all !</p><p>I also wanted to experiment more on smaller peripherals, like I2C, UARTs et al., and I wanted dedicated connectors on the board for them because why not.</p><h2 class="relative group">Pin multiplexing<div id=pin-multiplexing class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#pin-multiplexing aria-label=Anchor>#</a></span></h2><p>An SoC is essentially one or more CPUs and multiple peripherals connected together via various interconnects.</p><p>While CPUs are essentially processing data, peripherals sometimes use signals from the outer world. For example, an UART will have at least two signals, RX and TX, and likely have one control-flow signal per direction, which will add two more pins, CTS (Clear to Send) and RTS (Request to Send).</p><p>That&rsquo;s already 4 signals, for a single peripheral. And that&rsquo;s a rather low number of signals : memory access peripherals use data buses which use at least 8 signals (one byte), plus the various DIR/CLK signals.</p><p>Now imagine that we have 10 UART peripherals on the chip, that&rsquo;s already 40 pins used. Add the various SPI, I2C that may be present, the LCD peripherals, and so on, and you easily end up with hundreds or thousands of pins.</p><p>A normal chip package doesn&rsquo;t have that many pins : the LQFP-144, which is already a big one, only has 144 pins as the name states.</p><p>It simply cannot allow all peripherals to be used at the same time.</p><p>How is this not a problem then ? Well, simply because typical applications do not use all those peripherals.</p><p>Thanks to this, MCU manufacturers like ST have come up with a reasonable approach that we&rsquo;ll call pin multiplexing : every pin of the package is internally connectable to multiple signals (but to at most one at a time). The GPIO driver has to configure which alternate function (which index of each pin&rsquo;s multiplexer) is used. This is one of the first duties of any communication (USB, UART, etc&mldr;) device driver of such a chip : configure the pin multiplexing so that the signals used by the driven device are actually connected to the chip&rsquo;s pins. Then it can do other fun(damental) things like configuring the clocks and generating kernel panics.</p><p>The multiplexer can be large though. For ST&rsquo;s H7 line, it is 16 entries wide, meaning that each pin can be internally connected to at most 16 signals.</p><p>But the fun goes the other way too : multiple pins can be connected to the same signal, which makes this connection system a good old nightmare-ish graph.</p><p>To see how deep out of fun-land we are, this is an excerpt from my chip&rsquo;s multiplexing array.</p><figure><img class="my-0 rounded-md" src=/briztal.github.io/images/chip_gen/mux_table.png alt="mux table"><figcaption>page 1/14 of the stm32h750vb pin multiplexer.</figcaption></figure><p>This can be (painfully) translated into a machine readable text file that we&rsquo;ll use later.</p><p><a href=https://github.com/Briztal/kr_public/blob/master/stm32h7_muxer.txt target=_blank>Here is the one for my chip</a>.</p><p>For the record, that took almost 3 days of part-time fun and cost me a few neurons.</p><p>The sytax is quite simple and doesn&rsquo;t deserve a detailed explanation, it&rsquo;s just a line by line description where the first non whitespace char determines the described entity.</p><p>It could be possible to directly get this information from the pdf using a pdf-to-text-like manner. Though I tried that for a couple of hours and quickly ran out of patience.</p><h2 class="relative group">The problem<div id=the-problem class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#the-problem aria-label=Anchor>#</a></span></h2><p>Now back to our original problem : a devboard I wanted to design. And I knew what I wanted :</p><ul><li>4 UARTs, among 8.</li><li>3 SPIs, among 6.</li><li>2 I2Cs, among 4.</li><li>1 CAN, among 2.</li><li>1 4 bit SD interface, among 2.</li><li>1 USB with an ULPI interface, only 1 in the chip.</li><li>1 USB with a standard FS interface, only 1 in the chip.</li><li>1 Ethernet MDC + RMII interface, only 1 in the chip.</li></ul><p>When I say &lsquo;among&rsquo; in the list above, I mean that there are many devices of a kind in the SoC, but that I only want a certain number of them.
Those devices are, for all intents and purposes, strictly identical. Any of those can be selected.</p><p>The issue, as one could imagine, is that because the total number of pins is pretty low, and the number of signals is pretty high, there is a high chance of collision.</p><p>Now, if you think about it, I could just have try-and-errored in Kicad until I found a valid solution : if I saw that one peripheral needed one pin that was used by another, I would have discarded the one with the smallest priority and repeated the process.</p><p>As a matter of fact, I did try that. And it gets old. Veeeeeeryyyyyy quickly.</p><p>That&rsquo;s mostly because if you think about it for a moment, there are a LOT of possible combinations : let&rsquo;s imagine that we know exactly every peripheral that we need (forget the M among N-s in the previous list), and that we have 16 of them. Every one of them has 4 signals, and each signal can be routed to 2 pins. We literally have 64 pins that each have two possible values, which makes a total of 2^64 possible configurations.</p><p>And that&rsquo;s a lot. More than what your computer can index.</p><p>And doing that manually can be very long.</p><p>So after the first evening of failed attempts with the donk-ish manual way, I told myself it would be great to use the few remaining connected neurons to at least code something to accelerate the process.</p><h2 class="relative group">Objective<div id=objective class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#objective aria-label=Anchor>#</a></span></h2><p>With a given problem (certain peripherals to select) there could be a lot of possible solutions.</p><p>The objective of the algorithm will not be to find all solutions, not because it would be a bad idea, but simply because it would potentially consume all disk space on the machine.</p><p>In fact, as the reader will see, the resolution method contains the procedure to find all possible solutions. It is just that in most cases, finding just one solution is enough.</p><p>Thus, the objective of the algorithm will be to find one solution. If for some reason, that solution is not what the user expects, then the algorithm will easily find the next possible solutions.</p><h2 class="relative group">The expected output<div id=the-expected-output class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#the-expected-output aria-label=Anchor>#</a></span></h2><p>Ideally, we would like to be able to iteratively test multiple solutions for the same problem, in the same design.</p><p>To do that, we would like our algorithm to modify the connections in our Kicad schematics.</p><p>This is not doable per-se, but can be accomplished by structuring our Kicad schematics like the following :</p><p>The microcontroller only has labels connected to its GPIO pins, like what follows.</p><figure><img class="my-0 rounded-md" src=/briztal.github.io/images/chip_gen/CPU_label.png alt="CPU labels"><figcaption>Labels on the stm32h750 chip.</figcaption></figure><p>All the hardware connected to the GPIO pins (USB physical layer, ethernet PHY chip, UART connectors, etc&mldr;) only has labels connected to its signal pins, like what follows.</p><figure><img class="my-0 rounded-md" src=/briztal.github.io/images/chip_gen/peripherals_labels.png alt="peripherals labels"><figcaption>Labels on the board hardware.</figcaption></figure><p>Then, the only remaining thing is for our algorithm to generate a label associative array that for each GPIO pin of the microcontroller, connects to a hardware label, or to to GPIOs if the pin is not used like follows.</p><figure><img class="my-0 rounded-md" src=/briztal.github.io/images/chip_gen/label_array.png alt=label_array><figcaption>Labels associative array.</figcaption></figure><p>Luckily, Kicad uses text-based representations for the schematic components of a design, which allows us to copy-paste them. We will use that in a hacky manner, and make our algorithm generate the text representation of a label connection array.</p><p><a href=https://github.com/Briztal/kr_public/blob/master/kicad_labels.txt target=_blank>Here is the one for the previous image.</a></p><p>We will then copy paste that into kicad&rsquo;s schematics editor and that will be it.</p><h2 class="relative group">Numerical complexity<div id=numerical-complexity class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#numerical-complexity aria-label=Anchor>#</a></span></h2><p>There are two factors that cause the numerical complexity of the problem to exponentially increase : signals being connected to multiple pins, and us wanting to choose &ldquo;K peripherals in a set of N&rdquo;.</p><p>Let&rsquo;s formally establish the number of possible combinations that we should theoretically test.</p><p>First, each signal <code>sig</code> can be connected to multiple pins <code>pin_nb(sig)</code>.</p><p>Each peripheral <code>per</code> uses the set of signals <code>per_sigs(per)</code>.</p><p>Then, for each group <code>grp</code> (ex UART) of peripherals that we must use, we have <code>per_nb(grp)</code> peripherals available for that group and we must pick <code>chosen_nb(grp)</code> in that group.</p><p>Each group <code>grp</code> has <code>per_nb(grp) choose chosen_nb(grp)</code> possible configurations, with <code>n choose k = n! / (k! * (n - k)!)</code>.</p><p>Each configuration uses the set of peripherals <code>cfg_pers(cfg)</code>.</p><p>The total number of possible combinations to test can be written the following way :</p><p><code>N = PROD(grp in grps){ SUM(cfg in cfgs(grp)) { PROD(per in cfg_pers(cfg)) { PROD(per_sigs(per)) {pin_nb(sig)} } } }</code></p><p>Theoretically, we could just iterate over all those combinations, check if each is valid, and stop at the first valid one.</p><p>Though, if our model has a lot of peripherals with a lot of signals, we could iterate over a lot of combinations before finding a valid one.</p><p>In order for that search to be quicker, there are a few optimizations that we can do. During the development of this project, I was using a template design / peripheral selection as an example, and those optimizations made the number of potential solutions go from more than 2 ^ 64 to actually 16.</p><p>Not 2 ^ 16. I actually mean 16 combinations to try.</p><h2 class="relative group">Algorithmic data structures<div id=algorithmic-data-structures class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#algorithmic-data-structures aria-label=Anchor>#</a></span></h2><p>The first thing we must do is translate the pin multiplexing array in the microcontroller&rsquo;s doc into a machine readable text file that our algorithm will process.</p><p>That is long and painful, but trust me, it&rsquo;s worth it. It is very likely that all chips in the same family (ST&rsquo;s H7 for example) share the same multiplexing layout, so you may not have to do that frequently.</p><p>Then we can read this file, and build a graph-like in-ram data structure, where :</p><ul><li>each group references its possible configurations (k choose n)</li><li>each configuration references its peripherals.</li><li>each peripheral references its signals.</li><li>each signal references its pins.</li></ul><p>Here one must note :</p><ul><li>each configuration is part of one and exactly one group.</li><li>each peripheral can be referenced by multiple configurations of the same group. (A)</li><li>each signal is part of one and exactly one peripheral.</li><li>each pin can be referenced by multiple signals. (B)</li></ul><p>A and B are the two factors that were previously mentioned to make the complexity explode.</p><p>Those are the places where we must optimize things, by reducing the exploration space. Though, we cannot afford to remove a potential solution for the sake of speed. We must ensure that we only remove invalid configurations from the exploration space.</p><h2 class="relative group">Peripheral types<div id=peripheral-types class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#peripheral-types aria-label=Anchor>#</a></span></h2><p>In the next sections, when the expression &ldquo;for exploration purposes&rdquo; or &ldquo;FEP&rdquo; is used, it means &ldquo;given the current optimizations we found for the exploration&rdquo;. For example, a signal S can be connectable to a pin P, that is guaranteed to be connected to another signal in every valid combination. In this case, S will be considered disconnected from P for exploration purposes.</p><p>First, we can note that some peripherals are optional and some are mandatory :</p><ul><li>if a peripheral is part of a group where all peripherals will be chosen (FEP) (i.e. we choose N peripherals in a set of N, which is equivalent to having a group for each) then it is mandatory (FEP), in the sense that if a valid combination exists, this peripheral will be part of it.</li><li>otherwise, the peripheral is optional FEP in the sense that if a valid combination exists, it may or may not be part of it.</li></ul><p>If a peripheral is mandatory, then we can start to optimize its signals.</p><h2 class="relative group">Signals optimizations<div id=signals-optimizations class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#signals-optimizations aria-label=Anchor>#</a></span></h2><p>If a peripheral is mandatory, so are its signals. That means that if such a signal S can only be connected to one pin P, then it <em>must</em> be connected to it.</p><p>Other signals of other peripherals connected to this pin can just be considered not connected to it for exploration purposes, since if there is a valid configuration, S will be connected to P.</p><p>If a signal is found to be connected to no pin for exploration purposes (i.e all its possible pins are known to be connected to other signals), it means that the related peripheral cannot be present in the final solution, and that we can just remove this peripheral from the graph.</p><p>If the peripheral is mandatory, then no solution exists.</p><p>If the peripheral is optional, then we can actually remove it from the graph.</p><p>If we find a signal to be connected to multiple pins, and one of those pins P is connected to no other signal, then we can disconnect the signal connected to P and disconnect it from all other signals.</p><p>This effectively reduces the number of connections on other pins, which potentially allows us to re-apply the first optimization discussed above.</p><h2 class="relative group">Signals optimizations<div id=signals-optimizations-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#signals-optimizations-1 aria-label=Anchor>#</a></span></h2><p>If the peripheral is optional, then we can remove it from the exploration space (i.e. from the graph). This has two consequences.</p><p>First, every signal that we remove removes a connection to the pin that it was previously connected to. This potentially creates new pins with a single connection and we can re-apply the signal optimization sequence.</p><p>Then, every peripheral that we remove is optional, and thus, is part of a group where we chose K peripherals among N, with K &lt; N. Removing the peripheral reformulates the problem, by forcing us to choose K peripherals among <code>N - 1</code> peripherals.</p><p>If <code>K == N - 1</code>, then all remaining peripherals become mandatory, and we can optimize them all using signal optimizations.</p><p>If <code>K &lt; N - 1</code>, then all remaining peripherals are still optional.</p><p>In order to simplify the exploration space, we apply the signal optimizations and peripheral removal procedures repeatedly to the graph, until it leaves the graph unaffected.</p><p>Then, we can bruteforce the graph by testing the validity of all remaining combinations.</p><h2 class="relative group">Pathological case<div id=pathological-case class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#pathological-case aria-label=Anchor>#</a></span></h2><p>There is a case where those optimisations bring no improvement.</p><p>Let&rsquo;s imagine a simple scenario where we have 2 pins on our SOC, we want to select 2 mandatory peripherals, each peripheral has 1 signal that can be connected to both pins.</p><p>No optimization will work here, since each pin is connectable to 2 signals, and each signal is connectable to 2 pins.</p><p>Thus, those optimizations will not always improve performance, but they will statistically improve it a lot, since this kind of pathological case is rather rare, or only involves a low number of pins.</p></div></div><script>var oid="views_projects/chip_pinout_generator.md",oid_likes="likes_projects/chip_pinout_generator.md"</script><script type=text/javascript src=/briztal.github.io/js/page.min.b06a29d42a4ed16787978e2eee1e8c797b7698db2bc14ccee78f5c80ac566fc996190a73ad80a5e987558474b20b96fa38f7d85b405f165ff72b7b163c5ad11b.js integrity="sha512-sGop1CpO0WeHl44u7h6MeXt2mNsrwUzO549cgKxWb8mWGQpzrYCl6YdVhHSyC5b6OPfYW0BfFl/3K3sWPFrRGw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=briztal.github.io/projects/kasan/kasan_6_emulator/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Micro-KASAN : ARM Thumb Emulator.</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2023-11-15T00:00:00+00:00>15 November 2023</time></span></span></a></span>
<span><a class="flex text-right group ml-3" href=briztal.github.io/projects/bot/bot_0_intro/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Trading bot : introduction</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-06-10T00:00:00+00:00>10 June 2025</time></span></span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/briztal.github.io/js/process.min.62060bb247f4de2b6dde45903668fefb68d792f365587605177b1227c0cf43588701edaca0cb40e2c8e2789bd5ce67c1d2a215b9fb258c3496a7cd25e7cb5fdf.js integrity="sha512-YgYLskf03itt3kWQNmj++2jXkvNlWHYFF3sSJ8DPQ1iHAe2soMtA4sjieJvVzmfB0qIVufsljDSWp80l58tf3w=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=briztal.github.io style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>