<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>TurboJSON : JSON basics. &#183;</title><meta name=title content="TurboJSON : JSON basics. &#183; "><meta name=description content="Bases on JSON and how to parse it semi-efficiently."><link rel=canonical href=briztal.github.io/projects/jsn/jsn_prs_opt/><link type=text/css rel=stylesheet href=/briztal.github.io/css/main.bundle.min.29653ed199b7a749016920bb9715d240156e67049c90f12ffede5bb7f952606ecd8b0dd0c3f01d75af648960eddb25a879915d6e24858a75d11d9eed0607d9c6.css integrity="sha512-KWU+0Zm3p0kBaSC7lxXSQBVuZwSckPEv/t5bt/lSYG7Niw3Qw/Adda9kiWDt2yWoeZFdbiSFinXRHZ7tBgfZxg=="><script type=text/javascript src=/briztal.github.io/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script>
<script defer type=text/javascript id=script-bundle src=/briztal.github.io/js/main.bundle.min.5155d528b5217d2be660e88e103a0553710d2c94c85e3221100642905f3e6cbbb67b3760a44ab4f36703f12fbfe1d6f5b4545c3ae3a3f34784d919904ab7f1d7.js integrity="sha512-UVXVKLUhfSvmYOiOEDoFU3ENLJTIXjIhEAZCkF8+bLu2ezdgpEq082cD8S+/4db1tFRcOuOj80eE2RmQSrfx1w==" data-copy=Copy data-copied=Copied></script>
<script src=/briztal.github.io/lib/zoom/zoom.min.f592a181a15d2a5b042daa7f746c3721acf9063f8b6acd175d989129865a37d400ae0e85b640f9ad42cd98d1f8ad30931718cf8811abdcc5fcb264400d1a2b0c.js integrity="sha512-9ZKhgaFdKlsELap/dGw3Iaz5Bj+Las0XXZiRKYZaN9QArg6FtkD5rULNmNH4rTCTFxjPiBGr3MX8smRADRorDA=="></script>
<link rel=apple-touch-icon sizes=180x180 href=/briztal.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/briztal.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/briztal.github.io/favicon-16x16.png><link rel=manifest href=/briztal.github.io/site.webmanifest><meta property="og:title" content="TurboJSON : JSON basics."><meta property="og:description" content="Bases on JSON and how to parse it semi-efficiently."><meta property="og:type" content="article"><meta property="og:url" content="briztal.github.io/projects/jsn/jsn_prs_opt/"><meta property="article:section" content="projects"><meta property="article:published_time" content="2025-07-30T00:00:00+00:00"><meta property="article:modified_time" content="2025-07-30T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="TurboJSON : JSON basics."><meta name=twitter:description content="Bases on JSON and how to parse it semi-efficiently."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Personal Projects","name":"TurboJSON : JSON basics.","headline":"TurboJSON : JSON basics.","abstract":"Bases on JSON and how to parse it semi-efficiently.","inLanguage":"en","url":"briztal.github.io\/projects\/jsn\/jsn_prs_opt\/","author":{"@type":"Person","name":""},"copyrightYear":"2025","dateCreated":"2025-07-30T00:00:00\u002b00:00","datePublished":"2025-07-30T00:00:00\u002b00:00","dateModified":"2025-07-30T00:00:00\u002b00:00","mainEntityOfPage":"true","wordCount":"5001"}]</script><script src=/briztal.github.io/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/briztal.github.io class="text-base font-medium text-gray-500 hover:text-gray-900"></a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=briztal.github.io/projects/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title="Personal Projects">Projects</p></a><a href=briztal.github.io/about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title="About me">About</p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-1 rtl:ml-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><label id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=briztal.github.io/projects/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title="Personal Projects">Projects</p></a></li><li class=mt-1><a href=briztal.github.io/about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title="About me">About</p></a></li></ul></div></label></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">TurboJSON : JSON basics.</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-07-30T00:00:00+00:00>30 July 2025</time></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("briztal.github.io/categories/c/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">C</span></span></span>
<span style=margin-top:.5rem class=mr-2 onclick='return window.open("briztal.github.io/categories/arm64/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">ARM64</span></span></span>
<span style=margin-top:.5rem class=mr-2 onclick='return window.open("briztal.github.io/categories/optimization/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Optimization</span></span></span></div></div><div class="flex author"><div class=place-self-center><div class="text-2xl sm:text-lg"></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#context>Context</a></li><li><a href=#the-json-format>The JSON format</a></li><li><a href=#skipping-and-why-it-matters>Skipping, and why it matters</a></li><li><a href=#parsing-a-data-exchange-format>Parsing a data exchange format</a></li><li><a href=#sample-headers-macros-and-parsing-code>Sample headers, macros and parsing code</a></li><li><a href=#base-performance-metrics>Base performance metrics</a></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#bonus--why-i-made-this-command-line-tool>Bonus : why I made this command line tool</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#context>Context</a></li><li><a href=#the-json-format>The JSON format</a></li><li><a href=#skipping-and-why-it-matters>Skipping, and why it matters</a></li><li><a href=#parsing-a-data-exchange-format>Parsing a data exchange format</a></li><li><a href=#sample-headers-macros-and-parsing-code>Sample headers, macros and parsing code</a></li><li><a href=#base-performance-metrics>Base performance metrics</a></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#bonus--why-i-made-this-command-line-tool>Bonus : why I made this command line tool</a></li></ul></nav></div></details><script></script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><figure><img class="my-0 rounded-md" src=/briztal.github.io/images/jsn.png alt></figure><h2 class="relative group">Context<div id=context class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#context aria-label=Anchor>#</a></span></h2><p>While working on this project (TODO LINK) involving ARM64 register programming I quickly felt the need to have a small command line tool that would give me some info on a given register, to avoid constantly looking in the ARM64 spec.</p><p>Luckily for me, ARM folks did a great job (this time) and they nowadays release &ldquo;machine-readable&rdquo; descriptors of their ISA, in the form of gigantic JSON files describing among other things every register available.</p><blockquote><p>A while ago I had to implement an ARM32 emulator for my uKasan, but at that time I only had found the XML human-readable version which was a real pain to parse.
This JSON spec is MUCH better and I can&rsquo;t thank ARM folks enough for it.</p></blockquote><p>But simplicity never lasts long : when I can, I prefer re-coding my libraries myself and avoid relying on third party code, as well as programming in C.</p><p>Back then for uKasan, after looking for 2 long minutes at the immediately defaulted to python after looking at the <a href=https://www.liquid-technologies.com/Reference/Glossary/XML_EBNF1.1.html target=_blank>XML&rsquo;s EBNF</a> I quickly decided to doubly hold my nose and to :</p><ul><li>rely on a third party XML parsing library.</li><li>use python.</li></ul><p>which kinda hurt, let&rsquo;s be honest.</p><p>But JSON is a whole simpler kind of beast. A glance a the <a href=https://gist.github.com/springcomp/e72d09e3a8f06e8d711751c3d1ee160e target=_blank>JSON EBNF</a> will show you how simple it is compared to XML.</p><p>I have already implemented a couple of JSON parsers for past use cases, but those were small JSON files, and I cared more about the functionality itself than about its performance.</p><p>This time, it is different : the ARM64 Register descriptor is 82MB wide, so the parsing time is non-neglectible.</p><p>My wish was to have my little command line database load as quickly as possible, and the more it progressed, the more it looked like it could deserve its own article.</p><p>First, we will start by some general considerations on the JSON format and its parsing.
Then, we&rsquo;ll discuss some algorithmic optimizations that can increase the performance.
Then, we&rsquo;ll go a level below and try to optimize some steps of the parsing algorithm at the assembly level to increase the performance even more.</p><h2 class="relative group">The JSON format<div id=the-json-format class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#the-json-format aria-label=Anchor>#</a></span></h2><p>Anyone interested in the exact JSON syntax spec should definitely go checkout <a href=https://www.JSON.org/JSON-en.html target=_blank>this dedicated website</a>. It is great, and very clearly defines all the basic JSON data structures, so clearly that I was just tempted to post screenshots of it in this article. But I refrained.</p><p>Long story very short, the JSON file defines the basic value structure which can be any of :</p><ul><li>null : equivalent to void or none. Indicates the value of the XML format these days.</li><li>boolean : false or true.</li><li>number : decimal positive or negative integer or float.</li><li>string : sequence of chars delimited by double quotes, backslashed characters have special meanings.</li><li>array : sequence of values separated by commas and delimited by brackets.</li><li>object : sequence of <code>key (string) : value</code> separated by commas and delimited by brackets.</li></ul><p>Note that the beauty of the JSON is that the array and object structures contain values and hence make this format recursive. That will matter when we&rsquo;ll discuss parsing.</p><p>The json spec essentially defines the low level features of our parser. It will need to recognize every entity supported by the spec and parse it correctly.</p><h2 class="relative group">Skipping, and why it matters<div id=skipping-and-why-it-matters class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#skipping-and-why-it-matters aria-label=Anchor>#</a></span></h2><p>A parser is a piece of code able to extract and process data structured in a given format.</p><p>A counter-intuitive fact is that in practice, a (linear) parser is essentially a skip engine : at any given time, it knows :</p><ul><li>the position in the parsed file where it is at;</li><li>what entity is at the current position.</li><li>how to skip the current entity, aka move to the following.</li></ul><p>Let&rsquo;s see this with an example.</p><blockquote><p>In all this section, we will ignore whitespaces to keep the explanation simple.</p></blockquote><p>Let&rsquo;s suppose that our parser is at the start of an object, and that it wants to extract some information contained in this object.
The parser needs to skip the object start. The json format defines &lsquo;{&rsquo; as a single-character array start, so the parser can simply move to the next character.
The parser is now at a string start. As per the json format, the current char should be &lsquo;"&rsquo;. After checking this fact, the parser can move to the next character.
The parser is now in a string body. The json format defines that the string will end with a &lsquo;"&rsquo; not preceded by a &lsquo;/&rsquo;. It can move to the next character until it detects it. If the string should be stored somewhere, it can copy it directly.
The parser is now at a string end &lsquo;"&rsquo;. It can move to the next character.
The parser is now at a key-value separator. After checking that the current character is &lsquo;:&rsquo;, it can move to the next character.
The parser is now at a value start. It can now call the generic value parser which will :</p><ul><li>detect the value&rsquo;s first character; and</li><li>call the relevant substructure parser based on it; and</li><li>return the location at which parsing should resume (i.e : the location of the first character after the value.
The parser is now at either :</li><li>an array end &lsquo;}&rsquo;, in which case the parsing is done and the parser returns the location of the character after the &lsquo;}&rsquo;; or</li><li>a key:value separator &lsquo;,&rsquo;, in which case the parser reiterates the key-value parsing routine.</li></ul><p>So far, you can see that our parser is just a character skip engine with benefits : sometimes it may copy those characters or process them (for integer parsing), but what really matters is that it knows how to skip the current entity, in order to move to the next.</p><p>But you should also realize that skipping an entity is non-trivial.
In order for our object to be fully parsed (skipped), we will have needed to skip _ every single entity that composed it _.</p><p>This fact alone gives us the first golden rule of json parsing :</p><div class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"><span class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M506.3 417 293 53c-16.33-28-57.54-28-73.98.0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6c32.76.0 53.26-35 36.96-63zM232 168c0-13.25 10.75-24 24-24s24 10.8 24 24v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zm24 248c-17.36.0-31.44-14.08-31.44-31.44s14.07-31.44 31.44-31.44 31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg></span></span><span class=dark:text-neutral-300>DO NOT PARSE THE SAME VALUE TWICE.</span></div><p>We previously saw that the json spec itself defines almost entirely the low level aspect of our parser. But there is one question that is still pending : how are we going to use those low level features ? How are we going to parse our json&rsquo;s components ?</p><p>So before elaborating on the implications of the first rule, we need to define the high level features of our parser.</p><h2 class="relative group">Parsing a data exchange format<div id=parsing-a-data-exchange-format class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#parsing-a-data-exchange-format aria-label=Anchor>#</a></span></h2><p>A JSON file is essentially a data container. But are we always interested in all the information that it contains ?</p><p>In our case, the answer is no. The ARM64 json spec describes <em>everything</em> about the registers and instruction, but there are many things that we are not interested in (like &ldquo;Accessors&rdquo; ?!).</p><p>The job of our parser will be to extract <em>targetted</em> information.</p><p>For example, in our case, the ARM64 register spec is a gigantic array of register descriptors, where each register descriptor has a lot more info that we care about.</p><blockquote><p>In the following section, [.] means &ldquo;all entries of the array&rdquo;, and [&ldquo;xxx&rdquo;] means the value of the current object indexed by &ldquo;xxx&rdquo;.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>What</span> <span class=n>we</span> <span class=n>care</span><span class=p>,</span> <span class=n>and</span> <span class=n>the</span> <span class=n>way</span> <span class=n>to</span> <span class=n>access</span> <span class=n>it</span> <span class=n>in</span> <span class=n>the</span> <span class=n>json</span> <span class=nl>is</span> <span class=p>:</span>
</span></span><span class=line><span class=cl><span class=o>-</span> <span class=nl>root</span> <span class=p>:</span> <span class=nl>array</span> <span class=p>:</span> <span class=k>register</span> <span class=n>descriptor</span><span class=p>.</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span> <span class=p>[.]</span> <span class=o>:</span> <span class=nl>object</span> <span class=p>:</span> <span class=k>register</span> <span class=n>descriptor</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=o>-</span> <span class=p>[</span><span class=s>&#34;name&#34;</span><span class=p>]</span> <span class=o>:</span> <span class=nl>str</span> <span class=p>:</span> <span class=k>register</span> <span class=n>name</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=o>-</span> <span class=p>[</span><span class=s>&#34;purpose&#34;</span><span class=p>]</span> <span class=o>:</span> <span class=nl>str</span> <span class=p>:</span> <span class=k>register</span> <span class=nf>purpose</span> <span class=p>(</span><span class=n>null</span> <span class=mi>99</span><span class=o>%</span> <span class=n>of</span> <span class=n>the</span> <span class=n>time</span><span class=p>).</span>
</span></span><span class=line><span class=cl>    <span class=o>-</span> <span class=p>[</span><span class=s>&#34;title&#34;</span><span class=p>]</span> <span class=o>:</span> <span class=nl>str</span> <span class=p>:</span> <span class=k>register</span> <span class=nf>title</span> <span class=p>(</span><span class=n>null</span> <span class=mi>99</span><span class=o>%</span> <span class=n>of</span> <span class=n>the</span> <span class=n>time</span><span class=p>).</span>
</span></span><span class=line><span class=cl>    <span class=o>-</span> <span class=p>[</span><span class=s>&#34;fieldets&#34;</span><span class=p>]</span> <span class=o>:</span> <span class=nl>array</span> <span class=p>:</span> <span class=n>layouts</span> <span class=k>for</span> <span class=n>this</span> <span class=k>register</span> <span class=p>(</span><span class=n>bad</span> <span class=n>naming</span><span class=p>).</span>
</span></span><span class=line><span class=cl>      <span class=o>-</span> <span class=p>[.]</span> <span class=o>:</span> <span class=nl>object</span> <span class=p>:</span> <span class=n>layout</span> <span class=n>descriptor</span><span class=p>.</span>
</span></span><span class=line><span class=cl>        <span class=o>-</span> <span class=p>[</span><span class=s>&#34;width&#34;</span><span class=p>]</span> <span class=o>:</span> <span class=kt>int</span> <span class=o>:</span> <span class=n>layout</span> <span class=n>size</span> <span class=n>in</span> <span class=n>bits</span><span class=p>.</span>
</span></span><span class=line><span class=cl>        <span class=o>-</span> <span class=p>[</span><span class=s>&#34;values&#34;</span><span class=p>]</span> <span class=o>:</span> <span class=nl>array</span> <span class=p>:</span> <span class=n>bitfield</span> <span class=nf>descriptor</span> <span class=p>(</span><span class=n>any</span> <span class=n>suggestion</span> <span class=k>for</span> <span class=n>a</span> <span class=n>more</span> <span class=n>confusing</span> <span class=n>name</span> <span class=o>?</span><span class=p>).</span>
</span></span><span class=line><span class=cl>          <span class=o>-</span> <span class=p>[.]</span> <span class=o>:</span> <span class=nl>object</span> <span class=p>:</span> <span class=n>bitfield</span> <span class=n>descriptor</span><span class=p>.</span>
</span></span><span class=line><span class=cl>            <span class=o>-</span> <span class=p>[</span><span class=s>&#34;name&#34;</span><span class=p>]</span> <span class=o>:</span> <span class=nl>str</span> <span class=p>:</span> <span class=n>bitfield</span> <span class=n>name</span><span class=p>.</span>
</span></span><span class=line><span class=cl>            <span class=o>-</span> <span class=p>[</span><span class=s>&#34;rangeset&#34;</span><span class=p>]</span> <span class=o>:</span> <span class=nl>array</span> <span class=p>:</span> <span class=n>of</span> <span class=n>bit</span> <span class=n>range</span> <span class=n>descriptors</span><span class=p>.</span>
</span></span><span class=line><span class=cl>                <span class=o>-</span> <span class=p>[.]</span> <span class=o>:</span> <span class=nl>object</span> <span class=p>:</span> <span class=n>bitfield</span> <span class=n>descriptor</span><span class=p>.</span>
</span></span><span class=line><span class=cl>                  <span class=o>-</span> <span class=p>[</span><span class=s>&#34;start&#34;</span><span class=p>]</span> <span class=o>:</span> <span class=kt>int</span> <span class=o>:</span> <span class=n>bitfield</span> <span class=n>start</span><span class=p>.</span>
</span></span><span class=line><span class=cl>                  <span class=o>-</span> <span class=p>[</span><span class=s>&#34;width&#34;</span><span class=p>]</span> <span class=o>:</span> <span class=kt>int</span> <span class=o>:</span> <span class=n>bitfield</span> <span class=n>size</span><span class=p>.</span>
</span></span></code></pre></div><p>Our parser&rsquo;s high level features hence sound pretty simple :</p><ul><li>iterate over every element of an array and parse each element with a dedicated function.</li><li>iterate over <em>a</em> <em>certain</em> <em>set</em> of object elements indexed by specific keys and parse them with a dedicated function.</li></ul><p>Our previously established golden rule will have a consequence on the second feature : since we must avoid parsing anything twice, we can&rsquo;t afford to lookup an object once for each key that we are looking for. We will need to parse the object once and extract all elements in the order in which they appear.</p><h2 class="relative group">Sample headers, macros and parsing code<div id=sample-headers-macros-and-parsing-code class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#sample-headers-macros-and-parsing-code aria-label=Anchor>#</a></span></h2><p>Here are the declarations of both the low level and high level parts of the parser :</p><details><summary style="cursor:pointer;font-weight:700;margin:.5rem 0">Spec of the JSON parser.</summary><div style=max-height:500px;overflow:auto;margin-top:.1rem;border-radius:10px;padding:1rem><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#ifndef NS_LIB_JS_H
</span></span></span><span class=line><span class=cl><span class=cp>#define NS_LIB_JS_H
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/************
</span></span></span><span class=line><span class=cl><span class=cm> * Skip API *
</span></span></span><span class=line><span class=cl><span class=cm> ************/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Skip functions receive the location of the start of a json entity,
</span></span></span><span class=line><span class=cl><span class=cm> * and if it is valid, they return a pointer to the first character after
</span></span></span><span class=line><span class=cl><span class=cm> * the said entity.
</span></span></span><span class=line><span class=cl><span class=cm> * If it is invalid, they return 0.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Skip whitespaces.
</span></span></span><span class=line><span class=cl><span class=cm> * Never fails.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_skp_whs</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>start</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#define NS_JS_SKP_WHS(x) ({x = (typeof(x)) ns_js_skp_whs(x); check(x); x;})
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Skip &#34;true&#34;.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_skp_true</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>start</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Skip &#34;false&#34;.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_skp_false</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>start</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Skip &#34;null&#34;.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_skp_null</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>start</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Skip characters.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_skp_chars</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>start</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Skip a string.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_skp_str</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>start</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Skip a integer.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_skp_int</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>start</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Skip a fraction.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_skp_frc</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>start</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Skip an exponent.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_skp_exp</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>start</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Skip a number.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_skp_nb</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>start</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Skip a member.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_skp_mmb</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>start</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Skip members.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_skp_mmbs</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>start</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Skip members until the elment at @key.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_skp_mmbs_to</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>pos</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>key</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Skip an object.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_skp_obj</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>start</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Skip an element.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_skp_elm</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>start</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Skip elements.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_skp_elms</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>start</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Skip an array.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_skp_arr</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>start</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Skip a value.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_skp_val</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>start</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*****************
</span></span></span><span class=line><span class=cl><span class=cm> * Array parsing *
</span></span></span><span class=line><span class=cl><span class=cm> *****************/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Start the parsing of a json array starting at @start.
</span></span></span><span class=line><span class=cl><span class=cm> * Return the location of the first element if a valid array starts
</span></span></span><span class=line><span class=cl><span class=cm> * at @start, 0 if no valid array starts at @start.
</span></span></span><span class=line><span class=cl><span class=cm> * If the returned value is the end of the arra, set @end.
</span></span></span><span class=line><span class=cl><span class=cm> * If the returned array is a valid element, clear @end.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_arr_prs_stt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>start</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>u8</span> <span class=o>*</span><span class=n>end</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Return the start of the next element of the currently parsed array.
</span></span></span><span class=line><span class=cl><span class=cm> * @start is the value returned by either @ns_js_arr_parse_*.
</span></span></span><span class=line><span class=cl><span class=cm> * If the skip fails, return 0.
</span></span></span><span class=line><span class=cl><span class=cm> * If the returned value is the end of the array, set @end.
</span></span></span><span class=line><span class=cl><span class=cm> * If the returned array is a valid element, clear @end.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_arr_prs_skp</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>start</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>u8</span> <span class=o>*</span><span class=n>end</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Return the start of the next element of the currently parsed array.
</span></span></span><span class=line><span class=cl><span class=cm> * @pos is the value returned by either @ns_js_arr_parse_*.
</span></span></span><span class=line><span class=cl><span class=cm> * If the skip fails, return 0.
</span></span></span><span class=line><span class=cl><span class=cm> * If the returned value is the end of the array, set @end.
</span></span></span><span class=line><span class=cl><span class=cm> * If the returned array is a valid element, clear @end.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_arr_prs_nxt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>pos</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>u8</span> <span class=o>*</span><span class=n>end</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Finish the parsing of a json array ending at @start.
</span></span></span><span class=line><span class=cl><span class=cm> * Return the location of the next character after it, if a valid array ends
</span></span></span><span class=line><span class=cl><span class=cm> * at @start, 0 otherwise.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_arr_prs_end</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>start</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/******************
</span></span></span><span class=line><span class=cl><span class=cm> * Object parsing *
</span></span></span><span class=line><span class=cl><span class=cm> ******************/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Start the parsing of a json object starting at @pos.
</span></span></span><span class=line><span class=cl><span class=cm> * Return the location of the first element if a valid object starts
</span></span></span><span class=line><span class=cl><span class=cm> * at @pos, 0 if no valid object starts at @pos.
</span></span></span><span class=line><span class=cl><span class=cm> * If the returned value is the end of the object, set @end.
</span></span></span><span class=line><span class=cl><span class=cm> * If the returned object is a valid element, clear @end.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_obj_prs_stt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>pos</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>u8</span> <span class=o>*</span><span class=n>end</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Return the start of the next element of the currently parsed object.
</span></span></span><span class=line><span class=cl><span class=cm> * @pos is the value returned by either @ns_js_obj_parse_*.
</span></span></span><span class=line><span class=cl><span class=cm> * If the skip fails, return 0.
</span></span></span><span class=line><span class=cl><span class=cm> * If the returned value is the end of the object, set @end.
</span></span></span><span class=line><span class=cl><span class=cm> * If the returned object is a valid element, clear @end.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_obj_prs_skp</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>pos</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>u8</span> <span class=o>*</span><span class=n>end</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Return the start of the next element of the currently parsed object.
</span></span></span><span class=line><span class=cl><span class=cm> * @pos is the value returned by either @ns_js_obj_parse_*.
</span></span></span><span class=line><span class=cl><span class=cm> * If the skip fails, return 0.
</span></span></span><span class=line><span class=cl><span class=cm> * If the returned value is the end of the object, set @end.
</span></span></span><span class=line><span class=cl><span class=cm> * If the returned object is a valid element, clear @end.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_obj_prs_nxt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>pos</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>u8</span> <span class=o>*</span><span class=n>end</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Finish the parsing of a json object ending at @pos.
</span></span></span><span class=line><span class=cl><span class=cm> * Return the location of the next character after it, if a valid object ends
</span></span></span><span class=line><span class=cl><span class=cm> * at @pos, 0 otherwise.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_obj_prs_end</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>pos</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*************
</span></span></span><span class=line><span class=cl><span class=cm> * Iteration *
</span></span></span><span class=line><span class=cl><span class=cm> *************/</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Iterate over all elements of a container.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cp>#define ns_js_cnt_fe(typ, idt, jsn) \
</span></span></span><span class=line><span class=cl><span class=cp>for ( \
</span></span></span><span class=line><span class=cl><span class=cp>	char __ns_js_itr_end_##idt = ({jsn = (typeof(jsn)) ns_js_##typ##_prs_stt(jsn, (u8 *) &amp;__ns_js_itr_end_##idt); __ns_js_itr_end_##idt; }); \
</span></span></span><span class=line><span class=cl><span class=cp>	({if (__ns_js_itr_end_##idt) {jsn = (typeof(jsn)) ns_js_##typ##_prs_end(jsn);}; (__ns_js_itr_end_##idt == 0);}); \
</span></span></span><span class=line><span class=cl><span class=cp>	jsn = (typeof(jsn)) ns_js_##typ##_prs_nxt(jsn, (u8 *) &amp;__ns_js_itr_end_##idt) \
</span></span></span><span class=line><span class=cl><span class=cp>)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Iterate over all elements of an object.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cp>#define ns_js_obj_fe_(jsn, i) ns_js_cnt_fe(obj, i, jsn)
</span></span></span><span class=line><span class=cl><span class=cp>#define ns_js_obj_fe(jsn) ns_js_cnt_fe(obj, 0, jsn)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Iterate over all elements of an array.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cp>#define ns_js_arr_fe_(jsn, i) ns_js_cnt_fe(arr, i, jsn)
</span></span></span><span class=line><span class=cl><span class=cp>#define ns_js_arr_fe(jsn) ns_js_cnt_fe(arr, 0, jsn)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/**************
</span></span></span><span class=line><span class=cl><span class=cm> * Extraction *
</span></span></span><span class=line><span class=cl><span class=cm> **************/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define EXPAND(...) __VA_ARGS__
</span></span></span><span class=line><span class=cl><span class=cp>#define REMOVE(...)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Iterate over all members of the
</span></span></span><span class=line><span class=cl><span class=cm> * objecty starting at @jsn, and parse
</span></span></span><span class=line><span class=cl><span class=cm> * members that match the list of fields
</span></span></span><span class=line><span class=cl><span class=cm> * using dedicated extractors, storing them
</span></span></span><span class=line><span class=cl><span class=cm> * in locally defined variables. 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cp>#define NS_JS_XTR_DEF(nam, prs, str, len, ...) \
</span></span></span><span class=line><span class=cl><span class=cp>	_unused_ typeof(ns_js_prs_##prs(0 NS_PRP_CDN_EMP(__VA_ARGS__)(, __VA_ARGS__))) nam = 0;
</span></span></span><span class=line><span class=cl><span class=cp>#define NS_JS_XTR_PRS(nam, prs, str, len, ...) \
</span></span></span><span class=line><span class=cl><span class=cp>	if ((nam_siz == len NS_PRP_CDT_EMP(len) (sizeof(str) - 1)) &amp;&amp; (!strn_cmp(str, nam_stt, len NS_PRP_CDT_EMP(len) (sizeof(str) - 1)))) { \
</span></span></span><span class=line><span class=cl><span class=cp>		nam = ns_js_prs_##prs(&amp;__jsn NS_PRP_CDN_EMP(__VA_ARGS__)(, __VA_ARGS__)); \
</span></span></span><span class=line><span class=cl><span class=cp>		goto __found; \
</span></span></span><span class=line><span class=cl><span class=cp>	}
</span></span></span><span class=line><span class=cl><span class=cp>#define NS_JS_XTR(jsn, ...) \
</span></span></span><span class=line><span class=cl><span class=cp>	\
</span></span></span><span class=line><span class=cl><span class=cp>	</span><span class=cm>/* Define local variables to contain parsing results. */</span><span class=cp> \
</span></span></span><span class=line><span class=cl><span class=cp>	NS_PRP_CAL(NS_JS_XTR_DEF, EMPTY, __VA_ARGS__) \
</span></span></span><span class=line><span class=cl><span class=cp>	{ \
</span></span></span><span class=line><span class=cl><span class=cp>		typeof(jsn)__jsn = jsn; \
</span></span></span><span class=line><span class=cl><span class=cp>		ns_js_obj_fe_(__jsn, xtr) { \
</span></span></span><span class=line><span class=cl><span class=cp>			\
</span></span></span><span class=line><span class=cl><span class=cp>			</span><span class=cm>/* Skip the name, compute its length. */</span><span class=cp> \
</span></span></span><span class=line><span class=cl><span class=cp>			check(*__jsn == &#39;&#34;&#39;); \
</span></span></span><span class=line><span class=cl><span class=cp>			const char *nam_stt = __jsn + 1; \
</span></span></span><span class=line><span class=cl><span class=cp>			__jsn = (typeof(__jsn)) ns_js_skp_str(__jsn); \
</span></span></span><span class=line><span class=cl><span class=cp>			const char *nam_end = __jsn - 1; \
</span></span></span><span class=line><span class=cl><span class=cp>			check(nam_end &gt;= nam_stt); \
</span></span></span><span class=line><span class=cl><span class=cp>			const uad nam_siz = psub(nam_end, nam_stt); \
</span></span></span><span class=line><span class=cl><span class=cp>			\
</span></span></span><span class=line><span class=cl><span class=cp>			</span><span class=cm>/* Find the element. */</span><span class=cp> \
</span></span></span><span class=line><span class=cl><span class=cp>			NS_JS_SKP_WHS(__jsn); \
</span></span></span><span class=line><span class=cl><span class=cp>			check((*__jsn) == &#39;:&#39;); \
</span></span></span><span class=line><span class=cl><span class=cp>			__jsn++; \
</span></span></span><span class=line><span class=cl><span class=cp>			NS_JS_SKP_WHS(__jsn); \
</span></span></span><span class=line><span class=cl><span class=cp>			\
</span></span></span><span class=line><span class=cl><span class=cp>			</span><span class=cm>/* Compare all candidates. If found, jump to __found. */</span><span class=cp> \
</span></span></span><span class=line><span class=cl><span class=cp>			NS_PRP_CAL(NS_JS_XTR_PRS, EMPTY, __VA_ARGS__) \
</span></span></span><span class=line><span class=cl><span class=cp>			\
</span></span></span><span class=line><span class=cl><span class=cp>			</span><span class=cm>/* If not found, skip the colon and element. */</span><span class=cp> \
</span></span></span><span class=line><span class=cl><span class=cp>			__jsn = (typeof(__jsn)) ns_js_skp_val(__jsn); \
</span></span></span><span class=line><span class=cl><span class=cp>			\
</span></span></span><span class=line><span class=cl><span class=cp>			</span><span class=cm>/* Once parsed, focus on the next element or stop. */</span><span class=cp> \
</span></span></span><span class=line><span class=cl><span class=cp>			__found:; \
</span></span></span><span class=line><span class=cl><span class=cp>		} \
</span></span></span><span class=line><span class=cl><span class=cp>		jsn = __jsn; \
</span></span></span><span class=line><span class=cl><span class=cp>	}
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#endif </span><span class=cm>/* NS_LIB_JS_H */</span><span class=cp>
</span></span></span></code></pre></div></div></details><p>A few notes :</p><ul><li>the <code>Skip API</code> section defines the low level part of the parser. As we covered previously, it is mostly composed of functions that receive a pointer to the start of a particular entity, and that return the location of the next character after this entity.</li><li>the <code>Array parsing</code> and <code>Object parsing</code> sections define functions that allow a granular parsing of those containers, substructure by substructure.</li><li>the <code>Iteration</code> sections define macros that expand into for statements which use the container parsing utilities defined by the section above, they allow iterating over all elements of a container in a very compact way.</li><li>the <code>NS_JS_XTR</code> macro is the toplevel primitive to use to parse an object. In one single object processing sequence, it allows the simple extraction of a specified set of <code>key:value</code>. Since the types of the results of the parsing of those values depends on what we are parsing, it cannot be implemented as a function. Rather, it is a macro that expands into the dedicated object parsing sequence. It also automatically defines the variables that contain the result of the parsing.</li><li>If one takes a closer look at the <code>NS_JS_XTR</code> macro, they will notice that it internally uses macros prefixed by <code>NS_PRP</code> that it does not define. Those are part of my preprocessor tricks lib, which is out of the scope of this topic, but in particular :<ul><li><code>NS_PRP_CAL(name, separator, ...)</code> expands into a call to <code>name</code> with every value passed in <code>__VA_ARGS__</code>.</li><li><code>NS_PRP_CDT_EMP(cdt) (code)</code> will expand to <code>code</code> if <code>cdt</code> is empty and to nothing if <code>cdt</code> is not empty.</li><li><code>NS_PRP_CDT_EMP(cdt) (code)</code> will expand to nothing if <code>cdt</code> is empty and to <code>code</code> if <code>cdt</code> is not empty.</li></ul></li></ul><p>Now let&rsquo;s take a look at the code to extract (and simply print) the data that we need from the register spec.</p><details><summary style="cursor:pointer;font-weight:700;margin:.5rem 0">ARM64 register spec extraction code using the JSON parser.</summary><div style=max-height:500px;overflow:auto;margin-top:.1rem;border-radius:10px;padding:1rem><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Parse and return an u64.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=n>u64</span> <span class=nf>ns_js_prs_u64</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>**</span><span class=n>jsnp</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>jsn</span> <span class=o>=</span> <span class=o>*</span><span class=n>jsnp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>uerr</span> <span class=n>err</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>u64</span> <span class=n>val</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>end</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=nf>str_to_u64_auto</span><span class=p>(</span><span class=n>jsn</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>val</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>check</span><span class=p>(</span><span class=o>!</span><span class=n>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>jsnp</span> <span class=o>=</span> <span class=n>end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Parse and return a string or a &#39;null&#39;.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_prs_str_or_nul</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>**</span><span class=n>jsnp</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>jsn</span> <span class=o>=</span> <span class=o>*</span><span class=n>jsnp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=n>jsn</span> <span class=o>==</span> <span class=sc>&#39;n&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>*</span><span class=n>jsnp</span> <span class=o>=</span> <span class=n>jsn</span> <span class=o>+</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>end</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=nf>ns_js_skp_str</span><span class=p>(</span><span class=n>jsn</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=p>(</span><span class=n>end</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>jsnp</span> <span class=o>=</span> <span class=n>end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>jsn</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Parse a range set.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_prs_rng_set</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>**</span><span class=n>jsnp</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>jsn</span> <span class=o>=</span> <span class=o>*</span><span class=n>jsnp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Iterate over each fieldset. */</span>	
</span></span><span class=line><span class=cl>	<span class=nf>ns_js_arr_fe</span><span class=p>(</span><span class=n>jsn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nf>NS_JS_XTR</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=n>jsn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>stt</span><span class=p>,</span> <span class=n>u64</span><span class=p>,</span> <span class=s>&#34;start&#34;</span><span class=p>,),</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>wid</span><span class=p>,</span> <span class=n>u64</span><span class=p>,</span> <span class=s>&#34;width&#34;</span><span class=p>,)</span>
</span></span><span class=line><span class=cl>		<span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>info</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t\t\t</span><span class=s>rng :%U:%U</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>stt</span><span class=p>,</span> <span class=n>wid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>jsnp</span> <span class=o>=</span> <span class=n>jsn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Parse a field value.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_prs_fld_val</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>**</span><span class=n>jsnp</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>jsn</span> <span class=o>=</span> <span class=o>*</span><span class=n>jsnp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Iterate over each fieldset. */</span>	
</span></span><span class=line><span class=cl>	<span class=nf>ns_js_arr_fe</span><span class=p>(</span><span class=n>jsn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>NS_JS_XTR</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=n>jsn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>nam</span><span class=p>,</span> <span class=n>str_or_nul</span><span class=p>,</span> <span class=s>&#34;name&#34;</span><span class=p>,),</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>set</span><span class=p>,</span> <span class=n>rng_set</span><span class=p>,</span> <span class=s>&#34;rangeset&#34;</span><span class=p>,)</span>
</span></span><span class=line><span class=cl>		<span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>info</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t\t\t</span><span class=s>nam :%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>nam</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>jsnp</span> <span class=o>=</span> <span class=n>jsn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Parse register fieldset.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_prs_reg_flds</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>**</span><span class=n>jsnp</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>jsn</span> <span class=o>=</span> <span class=o>*</span><span class=n>jsnp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Iterate over each fieldset. */</span>	
</span></span><span class=line><span class=cl>	<span class=nf>ns_js_arr_fe</span><span class=p>(</span><span class=n>jsn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nf>NS_JS_XTR</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=n>jsn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>siz</span><span class=p>,</span> <span class=n>u64</span><span class=p>,</span> <span class=s>&#34;width&#34;</span><span class=p>,),</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>val</span><span class=p>,</span> <span class=n>fld_val</span><span class=p>,</span> <span class=s>&#34;values&#34;</span><span class=p>,)</span>
</span></span><span class=line><span class=cl>		<span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>info</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>fieldset :</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>info</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t\t</span><span class=s>siz :%U</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>siz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>jsnp</span> <span class=o>=</span> <span class=n>jsn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Parse the ARM64 register database.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_prs_rdb</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>**</span><span class=n>jsnp</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>jsn</span> <span class=o>=</span> <span class=o>*</span><span class=n>jsnp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* Iterate over each register. */</span>	
</span></span><span class=line><span class=cl>	<span class=nf>ns_js_arr_fe</span><span class=p>(</span><span class=n>jsn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=kt>char</span> <span class=o>*</span><span class=n>jsnm</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=n>jsn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=nf>NS_JS_XTR</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=n>jsnm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>flds</span><span class=p>,</span> <span class=n>reg_flds</span><span class=p>,</span> <span class=s>&#34;fieldsets&#34;</span><span class=p>,),</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>nam</span><span class=p>,</span> <span class=n>str</span><span class=p>,</span> <span class=s>&#34;name&#34;</span><span class=p>,),</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>prp</span><span class=p>,</span> <span class=n>str_or_nul</span><span class=p>,</span> <span class=s>&#34;purpose&#34;</span><span class=p>,),</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>ttl</span><span class=p>,</span> <span class=n>str_or_nul</span><span class=p>,</span> <span class=s>&#34;title&#34;</span><span class=p>,)</span>
</span></span><span class=line><span class=cl>		<span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>jsn</span> <span class=o>=</span> <span class=n>jsnm</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=nf>info</span><span class=p>(</span><span class=s>&#34;%s :</span><span class=se>\n\t</span><span class=s>%s</span><span class=se>\n\t</span><span class=s>%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>nam</span><span class=p>,</span> <span class=n>ttl</span><span class=p>,</span> <span class=n>prp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>jsnp</span> <span class=o>=</span> <span class=n>jsn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/********
</span></span></span><span class=line><span class=cl><span class=cm> * Main *
</span></span></span><span class=line><span class=cl><span class=cm> ********/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * rdb main.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=n>u32</span> <span class=nf>prc_rdb_main</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=n>u32</span> <span class=n>argc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>**</span><span class=n>argv</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Open and map the reg db. */</span>
</span></span><span class=line><span class=cl>	<span class=n>ns_res</span> <span class=n>stg_res</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>ns_stg</span> <span class=o>*</span><span class=n>stg</span> <span class=o>=</span> <span class=nf>nsk_stg_opn</span><span class=p>(</span><span class=o>&amp;</span><span class=n>stg_res</span><span class=p>,</span> <span class=s>&#34;/home/bt/Downloads/armdb/Registers.json&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=n>stg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>jsn</span> <span class=o>=</span> <span class=nf>ns_stg_map</span><span class=p>(</span><span class=n>stg</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nf>ns_stg_siz</span><span class=p>(</span><span class=n>stg</span><span class=p>),</span> <span class=n>NS_STG_ATT_RED</span> <span class=o>|</span> <span class=n>NS_STG_ATT_WRT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=n>jsn</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Parse. */</span>
</span></span><span class=line><span class=cl>	<span class=nf>ns_js_prs_rdb</span><span class=p>(</span><span class=o>&amp;</span><span class=n>jsn</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span></code></pre></div></div></details><p>A few notes :</p><ul><li>this relies heavily on my own standard library (all the ns_ prefixed stuff). In particular :</li><li>printing is made via <code>info</code>, format specifiers may look weird (<code>%U</code> for 64 bits integers). That&rsquo;s normal, since I use my own format decoder I took the liberty to reassign a few specifiers to cover up the stdlib&rsquo;s madness. In particular, <code>%u</code> and <code>%U</code> are unsigned ints, <code>%i</code> and <code>%I</code> are for signed ints, <code>%f</code> is for float, and <code>%d</code> is for double (in practice both are the same, given how the C handles float promotion in variadic args).</li><li>since we just print, parsers do not return anything. If we want to not <em>just</em> print, we can allocate structures on the fly with <code>malloc</code>, initialize them with the parsed data and return them. As long as the parser signatures are changed to reflect this, and that the parent callers do not lose track of them, no problem.</li></ul><p>Actually, let&rsquo;s do it.</p><p>Here is the code that parses the arm register db and that stores it in a tree-like data structure.</p><details><summary style="cursor:pointer;font-weight:700;margin:.5rem 0">ARM64 register spec extraction code using the JSON parser.</summary><div style=max-height:500px;overflow:auto;margin-top:.1rem;border-radius:10px;padding:1rem><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/**************
</span></span></span><span class=line><span class=cl><span class=cm> * Structures *
</span></span></span><span class=line><span class=cl><span class=cm> **************/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Bitfield.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Bitfields of the same register. */</span>
</span></span><span class=line><span class=cl>	<span class=n>ns_dls</span> <span class=n>bfls</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Name. */</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>nam</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Start. */</span>
</span></span><span class=line><span class=cl>	<span class=n>u8</span> <span class=n>stt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Size. */</span>
</span></span><span class=line><span class=cl>	<span class=n>u8</span> <span class=n>siz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>rdb_bfl</span><span class=p>;</span>	
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Register.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Registers of the same db. */</span>
</span></span><span class=line><span class=cl>	<span class=n>ns_mapn_str</span> <span class=n>regs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Bitfields. */</span>
</span></span><span class=line><span class=cl>	<span class=n>ns_dls</span> <span class=n>bfls</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Number of bits. */</span>
</span></span><span class=line><span class=cl>	<span class=n>u8</span> <span class=n>siz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>rdb_reg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * System.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Registers sorted by name. */</span>
</span></span><span class=line><span class=cl>	<span class=n>ns_map_str</span> <span class=n>regs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>rdb_sys</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/***********
</span></span></span><span class=line><span class=cl><span class=cm> * Parsers *
</span></span></span><span class=line><span class=cl><span class=cm> ***********/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Parse and return an u8.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=nf>ns_js_prs_u8</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>**</span><span class=n>jsnp</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>jsn</span> <span class=o>=</span> <span class=o>*</span><span class=n>jsnp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>uerr</span> <span class=n>err</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>u8</span> <span class=n>val</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>end</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=nf>str_to_u8_auto</span><span class=p>(</span><span class=n>jsn</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>val</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>check</span><span class=p>(</span><span class=o>!</span><span class=n>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>jsnp</span> <span class=o>=</span> <span class=n>end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Parse and return a string or a &#39;null&#39;.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_prs_str_or_nul</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>**</span><span class=n>jsnp</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>jsn</span> <span class=o>=</span> <span class=o>*</span><span class=n>jsnp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=n>jsn</span> <span class=o>==</span> <span class=sc>&#39;n&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>*</span><span class=n>jsnp</span> <span class=o>=</span> <span class=n>jsn</span> <span class=o>+</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>end</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=nf>ns_js_skp_str</span><span class=p>(</span><span class=n>jsn</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=p>(</span><span class=n>end</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>jsnp</span> <span class=o>=</span> <span class=n>end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>jsn</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Parse a range set, return the covered range.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=n>u16</span> <span class=nf>ns_js_prs_rng_set</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>**</span><span class=n>jsnp</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>jsn</span> <span class=o>=</span> <span class=o>*</span><span class=n>jsnp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Iterate over each bit range, enlarge if needed. */</span>
</span></span><span class=line><span class=cl>	<span class=n>u8</span> <span class=n>stt</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>u8</span> <span class=n>end</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>u8</span> <span class=n>mult</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>ns_js_arr_fe</span><span class=p>(</span><span class=n>jsn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nf>NS_JS_XTR</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=n>jsn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>_stt</span><span class=p>,</span> <span class=n>u8</span><span class=p>,</span> <span class=s>&#34;start&#34;</span><span class=p>,),</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>_siz</span><span class=p>,</span> <span class=n>u8</span><span class=p>,</span> <span class=s>&#34;width&#34;</span><span class=p>,)</span>
</span></span><span class=line><span class=cl>		<span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>u8</span> <span class=n>_end</span> <span class=o>=</span> <span class=n>_stt</span> <span class=o>+</span> <span class=n>_siz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=cm>/* Enlarge if needed. */</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>mult</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>_stt</span> <span class=o>&lt;</span> <span class=n>stt</span><span class=p>)</span> <span class=n>stt</span> <span class=o>=</span> <span class=n>_stt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>_end</span> <span class=o>&gt;</span> <span class=n>end</span><span class=p>)</span> <span class=n>end</span> <span class=o>=</span> <span class=n>_end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>stt</span> <span class=o>=</span> <span class=n>_stt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>end</span> <span class=o>=</span> <span class=n>_end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=n>stt</span> <span class=o>=</span> <span class=n>_stt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>mult</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>jsnp</span> <span class=o>=</span> <span class=n>jsn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=p>(</span><span class=n>u16</span><span class=p>)</span> <span class=n>stt</span> <span class=o>|</span> <span class=p>(</span><span class=n>u16</span><span class=p>)</span> <span class=p>(</span><span class=n>end</span> <span class=o>-</span> <span class=n>stt</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Parse a bit field array.
</span></span></span><span class=line><span class=cl><span class=cm> * Store allocated bitfield descriptors in @dst. 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=nf>ns_js_prs_bfl</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>**</span><span class=n>jsnp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>ns_dls</span> <span class=o>*</span><span class=n>dst</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>jsn</span> <span class=o>=</span> <span class=o>*</span><span class=n>jsnp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Iterate over each bitfield.
</span></span></span><span class=line><span class=cl><span class=cm>	 * Expect one in practice. */</span>	
</span></span><span class=line><span class=cl>	<span class=n>u8</span> <span class=n>mul</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>ns_js_arr_fe</span><span class=p>(</span><span class=n>jsn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>assert</span><span class=p>(</span><span class=o>!</span><span class=n>mul</span><span class=p>,</span> <span class=s>&#34;multi fieldset register.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>NS_JS_XTR</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=n>jsn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>nam</span><span class=p>,</span> <span class=n>str_or_nul</span><span class=p>,</span> <span class=s>&#34;name&#34;</span><span class=p>,),</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>set</span><span class=p>,</span> <span class=n>rng_set</span><span class=p>,</span> <span class=s>&#34;rangeset&#34;</span><span class=p>,)</span>
</span></span><span class=line><span class=cl>		<span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>nam</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nf>ns_alloc__</span><span class=p>(</span><span class=n>rdb_bfl</span><span class=p>,</span> <span class=n>bfl</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=nf>ns_dls_ib</span><span class=p>(</span><span class=n>dst</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>bfl</span><span class=o>-&gt;</span><span class=n>bfls</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>bfl</span><span class=o>-&gt;</span><span class=n>nam</span> <span class=o>=</span> <span class=n>nam</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>bfl</span><span class=o>-&gt;</span><span class=n>stt</span> <span class=o>=</span> <span class=p>(</span><span class=n>u8</span><span class=p>)</span> <span class=p>(</span><span class=n>set</span> <span class=o>&amp;</span> <span class=mh>0xff</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>bfl</span><span class=o>-&gt;</span><span class=n>siz</span> <span class=o>=</span> <span class=p>(</span><span class=n>u8</span><span class=p>)</span> <span class=p>((</span><span class=n>set</span> <span class=o>&gt;&gt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xff</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>jsnp</span> <span class=o>=</span> <span class=n>jsn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Parse a register layout array expectedly containing
</span></span></span><span class=line><span class=cl><span class=cm> * only one layout.
</span></span></span><span class=line><span class=cl><span class=cm> * Store bitfields in @dst.
</span></span></span><span class=line><span class=cl><span class=cm> * Return the register size.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=nf>ns_js_prs_reg_lyts</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>**</span><span class=n>jsnp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>ns_dls</span> <span class=o>*</span><span class=n>dst</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>jsn</span> <span class=o>=</span> <span class=o>*</span><span class=n>jsnp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Iterate over each fieldset. */</span>	
</span></span><span class=line><span class=cl>	<span class=n>u8</span> <span class=n>siz</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>u8</span> <span class=n>mult</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>ns_js_arr_fe</span><span class=p>(</span><span class=n>jsn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>assert</span><span class=p>(</span><span class=o>!</span><span class=n>mult</span><span class=p>,</span> <span class=s>&#34;multi-layout register.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nf>NS_JS_XTR</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=n>jsn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>_siz</span><span class=p>,</span> <span class=n>u8</span><span class=p>,</span> <span class=s>&#34;width&#34;</span><span class=p>,),</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>_val</span><span class=p>,</span> <span class=n>bfl</span><span class=p>,</span> <span class=s>&#34;values&#34;</span><span class=p>,,</span><span class=n>dst</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>siz</span> <span class=o>=</span> <span class=n>_siz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>jsnp</span> <span class=o>=</span> <span class=n>jsn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>siz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Parse the ARM64 register database.
</span></span></span><span class=line><span class=cl><span class=cm> * Store register content in @sys.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=nf>ns_js_prs_rdb</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>**</span><span class=n>jsnp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>rdb_sys</span> <span class=o>*</span><span class=n>sys</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>jsn</span> <span class=o>=</span> <span class=o>*</span><span class=n>jsnp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* Iterate over each register. */</span>	
</span></span><span class=line><span class=cl>	<span class=nf>ns_js_arr_fe</span><span class=p>(</span><span class=n>jsn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=cm>/* Parse the register descriptor,
</span></span></span><span class=line><span class=cl><span class=cm>		 * store bitfields in a local list. */</span>
</span></span><span class=line><span class=cl>		<span class=nf>ns_dls_def</span><span class=p>(</span><span class=n>bfls</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>NS_JS_XTR</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=n>jsn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>siz</span><span class=p>,</span> <span class=n>reg_lyts</span><span class=p>,</span> <span class=s>&#34;fieldsets&#34;</span><span class=p>,,</span><span class=n>bfls</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>nam</span><span class=p>,</span> <span class=n>str</span><span class=p>,</span> <span class=s>&#34;name&#34;</span><span class=p>,),</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>prp</span><span class=p>,</span> <span class=n>str_or_nul</span><span class=p>,</span> <span class=s>&#34;purpose&#34;</span><span class=p>,),</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>ttl</span><span class=p>,</span> <span class=n>str_or_nul</span><span class=p>,</span> <span class=s>&#34;title&#34;</span><span class=p>,)</span>
</span></span><span class=line><span class=cl>		<span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>assert</span><span class=p>(</span><span class=n>nam</span><span class=p>,</span> <span class=s>&#34;unnamed register.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=cm>/* Create a register descriptor,
</span></span></span><span class=line><span class=cl><span class=cm>		 * save the name, transfer bitfields. */</span>
</span></span><span class=line><span class=cl>		<span class=nf>ns_alloc__</span><span class=p>(</span><span class=n>rdb_reg</span><span class=p>,</span> <span class=n>reg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>uerr</span> <span class=n>err</span> <span class=o>=</span> <span class=nf>ns_map_str_put</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sys</span><span class=o>-&gt;</span><span class=n>regs</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>reg</span><span class=o>-&gt;</span><span class=n>regs</span><span class=p>,</span> <span class=n>nam</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>//debug(&#34;duplicate register &#39;%s&#39;.\n&#34;, nam); // There are a few of those...
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=n>rdb_bfl</span> <span class=o>*</span><span class=n>bfl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=nf>ns_dls_fes</span><span class=p>(</span><span class=n>bfl</span><span class=p>,</span> <span class=n>bfls</span><span class=p>,</span> <span class=n>bfls</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nf>ns_free_</span><span class=p>(</span><span class=n>bfl</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nf>ns_dls_init</span><span class=p>(</span><span class=n>bfls</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=nf>ns_free_</span><span class=p>(</span><span class=n>reg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nf>ns_dls_rp</span><span class=p>(</span><span class=n>bfls</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>reg</span><span class=o>-&gt;</span><span class=n>bfls</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>reg</span><span class=o>-&gt;</span><span class=n>siz</span> <span class=o>=</span> <span class=n>siz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=cm>/* Ensure nothing dangling. */</span>
</span></span><span class=line><span class=cl>		<span class=nf>ns_dls_del</span><span class=p>(</span><span class=n>bfls</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>jsnp</span> <span class=o>=</span> <span class=n>jsn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></div></details><p>Notes :</p><ul><li>while writing this code I renamed a few things, so the reader will notice changes in the parser names. No functional change is implemented.</li><li>allocation is performed using <code>ns_alloc__</code> which performs variable def, allocation and size computation at once for less C code.</li><li>the code uses some functions of my own (non-)standard library, namely, my linked list lib (<code>ns_dls</code>) and my map (<code>ns_map</code>) lib, so as their dedicated iterators.</li></ul><h2 class="relative group">Base performance metrics<div id=base-performance-metrics class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#base-performance-metrics aria-label=Anchor>#</a></span></h2><p>First, to have a vague idea of what is considered an acceptable decoding time, let&rsquo;s have the ARM64 register file decoded by another library.</p><p>Here I chose python for simplicity.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=nb>open</span><span class=p>(</span><span class=s1>&#39;/home/bt/Downloads/armdb/Registers.json&#39;</span><span class=p>))</span>
</span></span></code></pre></div><p>Let&rsquo;s run it and check how much time it takes.</p><pre tabindex=0><code>$ time python3 /tmp/test.py
real    0m0.403s
user    0m0.326s
sys     0m0.055s
</code></pre><p>Here, let&rsquo;s remember that we&rsquo;re asking python to :</p><ul><li>decode the whole file, which our case study code has to also do, because of what we covered earlier.</li><li>construct a python object tree to contain <em>all</em> <em>the</em> <em>information</em> contained in the JSON file.</li></ul><p>Hence, we&rsquo;re here asking python to do things that we are not doing on our side, so the python execution time must be considered just as a point of reference, and not as a relevant performance metric.</p><p>Just out of curiosity, I took a shot at doing the same thing (decoding the whole file and generating a C-like containerized version) with a library (<code>ct</code>) that I wrote a few years ago. This library is not optimized (it likely does some parsing multiple times) and its perf most certainly sucks but you&rsquo;ll see that the execution time (which is worse than python) stays in the same order of magnitude.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * rdb main.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=n>u32</span> <span class=nf>prc_rdb_main</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>u32</span> <span class=n>argc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/* Open and map the reg db. */</span>
</span></span><span class=line><span class=cl>        <span class=n>ns_res</span> <span class=n>stg_res</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ns_stg</span> <span class=o>*</span><span class=n>stg</span> <span class=o>=</span> <span class=nf>nsk_stg_opn</span><span class=p>(</span><span class=o>&amp;</span><span class=n>stg_res</span><span class=p>,</span> <span class=s>&#34;/home/bt/Downloads/armdb/Registers.json&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>assert</span><span class=p>(</span><span class=n>stg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>char</span> <span class=o>*</span><span class=n>jsn</span> <span class=o>=</span> <span class=nf>ns_stg_map</span><span class=p>(</span><span class=n>stg</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nf>ns_stg_siz</span><span class=p>(</span><span class=n>stg</span><span class=p>),</span> <span class=n>NS_STG_ATT_RED</span> <span class=o>|</span> <span class=n>NS_STG_ATT_WRT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>assert</span><span class=p>(</span><span class=n>jsn</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/* Parse the whole file and generate a tree-like representation. */</span>
</span></span><span class=line><span class=cl>        <span class=n>ct_val</span> <span class=o>*</span><span class=n>v</span> <span class=o>=</span> <span class=nf>ct_js_parse_value</span><span class=p>((</span><span class=k>const</span> <span class=kt>char</span> <span class=o>**</span><span class=p>)</span> <span class=o>&amp;</span><span class=n>jsn</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/* Yeah I know I didn&#39;t delete @v, it&#39;s just for show, who cares... (valgrind does...) */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Then let&rsquo;s run it :</p><pre tabindex=0><code>$ time build/prc/prc

real    0m0.591s
user    0m0.573s
sys     0m0.017s
</code></pre><p>I&rsquo;m taking around 50% more time to do it because my library is bad, but again, it&rsquo;s just to give you a rough estimate of how much time it takes on my machine to decode that large file.</p><blockquote><p>The reader may wonder as I did why the python side spends so much system time compared to mine. As you can see in the C code, I&rsquo;m mmap-ing the whole JSON file in RAM for simplicity, which also has the benefit of not relying on <code>fread</code> constantly. It&rsquo;s possible that the python side does rely on constant <code>fread</code>s which could explain this. Bad job on my side for doing worse than this if that&rsquo;s so.</p></blockquote><p>Now, let&rsquo;s run the code that I showed you at the end of the previous section, which actually extracts register info and does something with it.</p><p>This JSON decoder is <em>relatively</em> performant, in the sense that it does not do anything stupid like parse the same content multiple times (which my previous example certainly did). It also does not create a full in-memory representation of all the data in the JSON file.</p><p>Here I&rsquo;m having it decode the values of a register&rsquo;s bitfield given the register name and a value for it.</p><pre tabindex=0><code>$ time build/prc/prc dec -n PMUSERENR -v 10
PMUSERENR : 32
- [0]     : EN : 0x0
- [1]     : SW : 0x1
- [2]     : CR : 0x0
- [3]     : ER : 0x1

real    0m0.247s
user    0m0.243s
sys     0m0.003s
</code></pre><p>This duration is statistically relevant (run it multiple times and you&rsquo;ll get a reasonably close time), and reliably reflects the JSON parsing time : just to be sure, I purposefully removed all the data allocation and deallocation, and it was statistically the same : all the execution time is spent in parsing the JSON.</p><p>Hence, this time will be our base performance metric for the next chapters.</p><p>Let&rsquo;s see how much we can shrink it !</p><h2 class="relative group">Conclusion<div id=conclusion class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#conclusion aria-label=Anchor>#</a></span></h2><p>This article should have stated the base notions required to understand what JSON is, how it is parsed, and the potential difficulties and perf problems that arise when doing so.</p><p>The next part will show some high level algorithmic tricks to make this process more efficient.</p><h2 class="relative group">Bonus : why I made this command line tool<div id=bonus--why-i-made-this-command-line-tool class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#bonus--why-i-made-this-command-line-tool aria-label=Anchor>#</a></span></h2><p>With that json database, a simple command line tool can do a lot of things for you. Here are the features that matter to me as a machine-level programmer :</p><pre tabindex=0><code>$ build/prc/prc -h
Available rdb commands :
  lst : list registers.
  reg : show info about a register.
  dec : decode the value of a register.
  lyt : generate a C register layout struct.
</code></pre><p>List registers starting with a prefix.</p><pre tabindex=0><code>$ build/prc/prc lst -n PMU
PMU
PMUACR_EL1
PMUSERENR
PMUSERENR_EL0
</code></pre><p>Generate a C struct to directly manipulate bitfields in an easy way. Let&rsquo;s see it in action with the ARM CPSR.</p><pre tabindex=0><code>$ time build/prc/prc lyt -n CPSR
typedef union {
        uint32_t bits;
        struct {
                uint32_t M : 4;
                uint32_t __res0 : 2;
                uint32_t F : 1;
                uint32_t I : 1;
                uint32_t A : 1;
                uint32_t E : 1;
                uint32_t __res1 : 6;
                uint32_t GE : 4;
                uint32_t __res2 : 7;
                uint32_t Q : 1;
                uint32_t V : 1;
                uint32_t C : 1;
                uint32_t Z : 1;
                uint32_t N : 1;
        };
} CPSR_t;

real    0m0.243s
user    0m0.240s
sys     0m0.003s
</code></pre><p>(<code>dec</code> just does what <code>reg</code> does with the added decoding and I already covered <code>dec</code> in the previous section.)</p></div></div><script>var oid="views_projects/jsn/jsn_prs_opt.md",oid_likes="likes_projects/jsn/jsn_prs_opt.md"</script><script type=text/javascript src=/briztal.github.io/js/page.min.b06a29d42a4ed16787978e2eee1e8c797b7698db2bc14ccee78f5c80ac566fc996190a73ad80a5e987558474b20b96fa38f7d85b405f165ff72b7b163c5ad11b.js integrity="sha512-sGop1CpO0WeHl44u7h6MeXt2mNsrwUzO549cgKxWb8mWGQpzrYCl6YdVhHSyC5b6OPfYW0BfFl/3K3sWPFrRGw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=briztal.github.io/projects/bot/bot_3_seq/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Trading bot : trade sequence.</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-07-19T00:00:00+00:00>19 July 2025</time></span></span></a></span>
<span></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/briztal.github.io/js/process.min.62060bb247f4de2b6dde45903668fefb68d792f365587605177b1227c0cf43588701edaca0cb40e2c8e2789bd5ce67c1d2a215b9fb258c3496a7cd25e7cb5fdf.js integrity="sha512-YgYLskf03itt3kWQNmj++2jXkvNlWHYFF3sSJ8DPQ1iHAe2soMtA4sjieJvVzmfB0qIVufsljDSWp80l58tf3w=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=briztal.github.io style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>