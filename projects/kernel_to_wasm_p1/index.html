<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Joys of porting a kernel to WebAssembly, Part 1. &#183;</title><meta name=title content="Joys of porting a kernel to WebAssembly, Part 1. &#183; "><meta name=description content="In-process kernels, WebAssembly and their difficulties to cohabitate."><meta name=keywords content="C,wasm,Emscripten,Kernel,Web Development,Webassembly,gnu,"><link rel=canonical href=briztal.github.io/projects/kernel_to_wasm_p1/><link type=text/css rel=stylesheet href=/briztal.github.io/css/main.bundle.min.29653ed199b7a749016920bb9715d240156e67049c90f12ffede5bb7f952606ecd8b0dd0c3f01d75af648960eddb25a879915d6e24858a75d11d9eed0607d9c6.css integrity="sha512-KWU+0Zm3p0kBaSC7lxXSQBVuZwSckPEv/t5bt/lSYG7Niw3Qw/Adda9kiWDt2yWoeZFdbiSFinXRHZ7tBgfZxg=="><script type=text/javascript src=/briztal.github.io/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script>
<script defer type=text/javascript id=script-bundle src=/briztal.github.io/js/main.bundle.min.5155d528b5217d2be660e88e103a0553710d2c94c85e3221100642905f3e6cbbb67b3760a44ab4f36703f12fbfe1d6f5b4545c3ae3a3f34784d919904ab7f1d7.js integrity="sha512-UVXVKLUhfSvmYOiOEDoFU3ENLJTIXjIhEAZCkF8+bLu2ezdgpEq082cD8S+/4db1tFRcOuOj80eE2RmQSrfx1w==" data-copy=Copy data-copied=Copied></script>
<script src=/briztal.github.io/lib/zoom/zoom.min.f592a181a15d2a5b042daa7f746c3721acf9063f8b6acd175d989129865a37d400ae0e85b640f9ad42cd98d1f8ad30931718cf8811abdcc5fcb264400d1a2b0c.js integrity="sha512-9ZKhgaFdKlsELap/dGw3Iaz5Bj+Las0XXZiRKYZaN9QArg6FtkD5rULNmNH4rTCTFxjPiBGr3MX8smRADRorDA=="></script>
<link rel=apple-touch-icon sizes=180x180 href=/briztal.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/briztal.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/briztal.github.io/favicon-16x16.png><link rel=manifest href=/briztal.github.io/site.webmanifest><meta property="og:title" content="Joys of porting a kernel to WebAssembly, Part 1."><meta property="og:description" content="In-process kernels, WebAssembly and their difficulties to cohabitate."><meta property="og:type" content="article"><meta property="og:url" content="briztal.github.io/projects/kernel_to_wasm_p1/"><meta property="article:section" content="projects"><meta property="article:published_time" content="2021-10-07T00:00:00+00:00"><meta property="article:modified_time" content="2021-10-07T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Joys of porting a kernel to WebAssembly, Part 1."><meta name=twitter:description content="In-process kernels, WebAssembly and their difficulties to cohabitate."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Personal Projects","name":"Joys of porting a kernel to WebAssembly, Part 1.","headline":"Joys of porting a kernel to WebAssembly, Part 1.","abstract":"In-process kernels, WebAssembly and their difficulties to cohabitate.","inLanguage":"en","url":"briztal.github.io\/projects\/kernel_to_wasm_p1\/","author":{"@type":"Person","name":""},"copyrightYear":"2021","dateCreated":"2021-10-07T00:00:00\u002b00:00","datePublished":"2021-10-07T00:00:00\u002b00:00","dateModified":"2021-10-07T00:00:00\u002b00:00","keywords":["C","wasm","Emscripten","Kernel","Web Development","Webassembly","gnu"],"mainEntityOfPage":"true","wordCount":"3327"}]</script><script src=/briztal.github.io/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/briztal.github.io class="text-base font-medium text-gray-500 hover:text-gray-900"></a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=briztal.github.io/projects/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title="Personal Projects">Projects</p></a><a href=briztal.github.io/about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title="About me">About</p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-1 rtl:ml-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><label id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=briztal.github.io/projects/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title="Personal Projects">Projects</p></a></li><li class=mt-1><a href=briztal.github.io/about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title="About me">About</p></a></li></ul></div></label></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Joys of porting a kernel to WebAssembly, Part 1.</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2021-10-07T00:00:00+00:00>7 October 2021</time></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("briztal.github.io/tags/c/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">C</span></span></span>
<span style=margin-top:.5rem class=mr-2 onclick='return window.open("briztal.github.io/tags/wasm/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">wasm</span></span></span>
<span style=margin-top:.5rem class=mr-2 onclick='return window.open("briztal.github.io/tags/emscripten/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Emscripten</span></span></span>
<span style=margin-top:.5rem class=mr-2 onclick='return window.open("briztal.github.io/tags/kernel/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kernel</span></span></span>
<span style=margin-top:.5rem class=mr-2 onclick='return window.open("briztal.github.io/tags/web-development/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Web Development</span></span></span>
<span style=margin-top:.5rem class=mr-2 onclick='return window.open("briztal.github.io/tags/webassembly/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Webassembly</span></span></span>
<span style=margin-top:.5rem class=mr-2 onclick='return window.open("briztal.github.io/tags/gnu/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">gnu</span></span></span></div></div><div class="flex author"><div class=place-self-center><div class="text-2xl sm:text-lg"></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><h1 class="relative group">The back story<div id=the-back-story class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#the-back-story aria-label=Anchor>#</a></span></h1><p>For as long as I can remember, understanding how kernels were designed and
written was something that has interested me.</p><p>In the beginning, a newcomer to the world of programming, I saw them as
mysterious, incredibly complex and barely comprehensible software blocks,
handling equally mysterious tasks in the execution of a program.</p><p>A few years later, after having perfected my skills as a programmer, I dived
into the concept with a new perspective, and discovered the real issues that
required the use of kernels and the possible implementations choices that solved
these problems.</p><p>Afterwards, I did what every normal programmer would do in my situation and
spent more than the next half decade implementing my own one.</p><p>Last year, I discovered WebAssembly, an Intermediate Representation allowing the
deployment of C software in a web-browser. In order to make this port possible I
had to update a part of my code base to support WebAssembly, and it was within
that context that I set upon myself the challenge of :</p><blockquote><p>porting the kernel to the wasm environment.
WebAssembly and its related toolchain, Emscripten, have done a very respectable
work in providing support for C99 with gnu extensions (ex : constructs like
({statements})), allowing regular C libraries to be ported without any issue.</p></blockquote><p>Yet, I encountered my fair share of interesting issues when porting my kernel to
this environment. After all, kernel’s are quite far from the simple
standard-compliant C code, and as such forced me to push to the boundaries of
the emscripten wasm toolchain and get familiar with it’s nooks and crannies.</p><p>This article’s aim is to describe these difficulties in more detail and hopes
to, in the process, give you glimpses of how kernel’s on one hand and the
emscripten toolchain, on the other, work under the hood.</p><p>I will start this article by briefly introducing Webassembly, and I will then
tell you more about the main needs that pushed me to implement my own kernel,
and in doing so, I will give a short description of its main blocks. Following
this, I will provide a more detailed look at the Emscripten toolchain, to expose
a corner case that forced me to reimplement a part of the kernel’s init
procedure to support WebAssembly.</p><h1 class="relative group">Web-browsers and Javascript<div id=web-browsers-and-javascript class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#web-browsers-and-javascript aria-label=Anchor>#</a></span></h1><p>Historically designed to render statically defined text-based pages,
web-browsers have drastically evolved to the point we know, being nowadays
having more in common with actual Operating Systems than simple page renderers.</p><p>Web-browsers getting more and more complex and varying in their implementations,
and web-designers desiring to avoid as much as possible taking the execution
browser brand (firefox, chrome, …) into account during development, it was
central to provide a stable common API. Javascript rapidly took this place, the
Javascript VM now being one of the central components of a web-browser.</p><p>Javascript being an interpreted complex language, its execution performances
rapidly showed their limits, even with JIT features enabled. In a world where
Moore’s law applies, this may not seem like a real issue, as the assumption that
the next generation of computer will provide enough performance increase to
compensate for this slowness. Though, in our years where this law clearly
started to present its validity limits, this issue had to be addressed.</p><h1 class="relative group">WebAssembly<div id=webassembly class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#webassembly aria-label=Anchor>#</a></span></h1><p>Webassembly is a relatively new (2017) trending IR (Intermediate Representation)
code format designed to be loaded and interpreted, translated or JITed in, among
others, web-browsers.</p><figure><img class="my-0 rounded-md" src=https://upload.wikimedia.org/wikipedia/commons/1/1f/WebAssembly_Logo.svg alt="Wasm logo"><figcaption>Wasm logo</figcaption></figure><p>An intermediate representation is, as the name states, a manner to represent a
program that doesn’t aim to be directly executed, but rather :</p><ul><li><p>to serve as storage or exchange format.</p></li><li><p>to be interpreted efficiently by a wide range of program processors
(compilers, VMs etc…), to be either translated into other formats (ex : actual
assembly) or directly executed.</p></li></ul><p>WebAssembly is, as a consequence, not a programming language (though the textual
version may be used this way), but rather an object format that compilers may
use to store the result of their compilation, and that a virtual machine may use
as executable source.</p><p>This allows a possible wide range of programming languages to be compiled into
it, for example C or Rust for the most widely known.</p><p>Though its reputation may be tainted due to its strong use by web hackers to
inject (among others) crypto-mining payloads in client side, webassembly remains
a good option for porting C libraries in the Web world.</p><h1 class="relative group">Kernels, or the need for environment abstraction layers<div id=kernels-or-the-need-for-environment-abstraction-layers class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#kernels-or-the-need-for-environment-abstraction-layers aria-label=Anchor>#</a></span></h1><p>As any software engineer I aim to write <em>“good”</em> code. Naturally, pretty fast,
the problem of defining what <em>“good code”</em> is arises. After all, given a choice
between multiple possible implementations, it would be best to have some
criterion.</p><p>Though I recognize that these criterion are not universal, in my implementations
at least I now consider 4 performance indicators that I have listed them below
in decreasing importance :</p><ul><li><p><strong>portability</strong> : the code must be compatible with the widest scope of
environments.</p></li><li><p><strong>functionalities</strong> : the code must offer an answer to the most general
problem.</p></li><li><p><strong>memory consumption</strong> : the code must use the smallest amount of memory,
considering the previous rules.</p></li><li><p><strong>execution time</strong> : the code must run as fast as possible, considering the
previous rules.</p></li></ul><p>I wish to once more remind the reader that these criterion are completely
subjective, and are only the reflection of my experience and my objectives.</p><p>It is certain that real-time software engineers would have radically different
guidelines, and would, for example, place execution time invariability, or
avoidance of linked lists traversals inside critical sections, on top of their
list.</p><p>But let us go back to my criterion.</p><p>Generally, I tend to place code reusability across use-cases and environments
among every other requirement.</p><p>When I say environment, I mean the platforms (x8664, x8632, arm32, aarch64),
host OS (freestanding, linux, windows, mbedOS) and toolchain (gcc, llvm).</p><p>This means that the code I write must be as independent as possible of the host
API its executable version will access.</p><p>Having this constraint implies defining standard custom APIs for the most basic
host requirements of a program :</p><ul><li><p><strong>host memory access</strong> : ex for stdlib : <code>malloc</code>, <code>free</code>.</p></li><li><p><strong>host memory mapping</strong> : ex for linux : <code>mmap</code>, <code>mprotect</code>, <code>munmap</code>.</p></li><li><p><strong>host file access</strong> : ex : printf, for linux : <code>open</code>, <code>close</code>, <code>read</code>,
<code>write</code>, <code>seek</code>.</p></li><li><p><strong>host directory access</strong> : ex for linux : <code>readdir</code>, <code>closedir</code>, <code>seekdir</code>.</p></li><li><p><strong>threading : ex for linux</strong> : <code>pthread</code> environment.</p></li></ul><h1 class="relative group">The need for freestanding implementation<div id=the-need-for-freestanding-implementation class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#the-need-for-freestanding-implementation aria-label=Anchor>#</a></span></h1><p>To achieve the aforementioned code reusability objective, in a classic hosted
environment defining a simple function indirections (static inline functions or
macro aliases in a shared header) will do the job.</p><p>That being said, as an embedded software engineer, my primary environment
targets are freestanding (without OS, bare-metal) systems, not hosted ones,
which complicates the problem.</p><p>Though, it is still possible to use frameworks for those freestanding systems,
that would provide some semblance of a standard environment. The Arduino
framework, being one example, offers a default standard for low-performance
embedded systems. In this case the previous simple solution would still be
viable.</p><p>But, after a more thorough examination and more experience with these frameworks
I have started to have several objections regarding their use :</p><ul><li><p><strong>code quality</strong> : a simple look in an Arduino framework implementation is
enough to leave one, at best doubtful, at worst frightened by the code quality
and the apparent absence of debugging efforts.</p></li><li><p><strong>code performance</strong> : for example, the quality of the memory management
system may be weak, which could lead to memory allocation poor performances,
which could impact the whole program.</p></li><li><p><strong>missing features</strong> : platforms like the teensy35 (a platform nevertheless
close to my heart as it was my entry point into embedded systems and my
hardware of choice for a few years) is based on a cortex-m4f based on the ARMV7M
architecture. As such, it features all of the architectural components required
to implement a context-switch based mono-core threading API. Yet, the Arduino
framework is primarily made to provide an uniform API for extremely low-power
cores like AVR8 chips. As such it doesn’t provide a satisfying threading API,
and so, if an implementation is required, it must be implemented manually.</p></li><li><p><strong>language constraints</strong> : the Arduino framework is written in C++, which
doesn’t ease the development of pure-C applications.</p></li></ul><p>As a consequence, for freestanding systems, it becomes a necessity to have an
available working implementation of the basic code blocks to support at least :</p><ul><li><p>memory allocation.</p></li><li><p>memory mapping (if any).</p></li><li><p>file access.</p></li><li><p>threading.</p></li></ul><p>And those blocks happen to be the minimal blocks needed for a kernel.</p><p>#The need for code compatibility between freestanding and hosted environments</p><p>Hosted and freestanding environments are different in many ways, but, most
probably the most painful difference between the two for any programmer is the
difference in debugging capabilities.</p><p>On the one hand, debugging on a hosted environment (ex : linux process) is very
easy and fast. Tools like <mark>valgrind</mark> are extremely versatile, easy to use and can
allow the developer to have an exhaustive list of all invalid accesses, memory
leaks, uninitialized accesses, without requiring any additional instrumentation.
Program faults are handled by the host and faults’ side-effects are reduced, as
the host will close any used file, resource, etc…</p><p>On the other hand debugging on a freestanding environment is much more of a
headache and may require a particularly expensive instrumentation (the most
well-known toolkit being the Segger’s J-Link) to set up a gdb server, in the
best case.</p><p>An invaluable tool like valgrind being a simulation-based debug tool, it only
supports its host’s instruction set, and as such can’t be adapted to this
environment. As such our debugging capabilities are greatly reduced.</p><p>Memory leaks will be harder to detect, uninitialized accessed will be
untraceable.</p><p>Program faults may be fatal, if not handled properly, as they may put the
program in an unsafe state. Worst, if the related program is a controller for
physical objects, may lead to erratic behaviours with repercussions in the
physical world, which may be inconvenient if not harmful.</p><p>As a consequence, we have two complementary environments, one that depends on a
safe and verified code but can’t provide ways to verify it, and another that
provides such ways, but for which the consequences of not having a dependable
and verified code are much lower.</p><p>As such we can make up for the shortcoming of the freestanding environment by
making the code as much platform-independent as possible. This allows for a
rigorous stress-testing and debugging of shared code via standardised, powerful
and robust tools in the hosted environment, and safe deployment of this verified
code on freestanding platforms.</p><h1 class="relative group">A simple user space kernel<div id=a-simple-user-space-kernel class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#a-simple-user-space-kernel aria-label=Anchor>#</a></span></h1><p>Though the definition of what is and what is not a kernel may be a subject of
debate, I believe the best definition to start with is the following :</p><blockquote><p>a kernel manages shared resources in a system.</p></blockquote><p>Those resources may be :</p><ul><li><p>cores.</p></li><li><p>Tasks (and threads and processes).</p></li><li><p>Executables, the kernel executable at first, then possible dynamic libraries
and modules.</p></li><li><p>Memory.</p></li><li><p>Peripherals.</p></li><li><p>Files.</p></li></ul><p>More generally, a kernel aims to manage any shared resources accessible by
multiple programs in a system. The role of the kernel is to supervise the access
to those resources, by providing a consistent API to use them.</p><p>Contrary to what is most common for a kernel, my kernel will run in user-space.</p><p>Normally kernels do not do this and isolate its threads from itself via the
virtualisation / protection mechanisms offered by MMUs or MPUs. My kernel
doesn’t include this feature as protection mechanisms from the MMUs and MPUs may
be absent on the targeted systems. This can occur when the kernel is run in the
process space on a hosted system (no MMU, may be emulated via linux-KVM if
relevant but that’s another story), or on a cortex-m4f (implementation-defined
MPU capabilities but no MMU).</p><p>That aside, the kernel implements most of the features that you would expect to
encounter :</p><ul><li><strong>BSP</strong> : environment dependent code, provides a standardised API to interact
with cores, host memory managers, host file manager, etc…</li><li><strong>Memory manager</strong> : responsible for managing primary memory and to provide
secondary memory APIs to cores. See my detailed article on this topic.</li><li><strong>Scheduler</strong> : decentralised system responsible for scheduling tasks on each
core, and to coordinate the transfer of tasks between cores depending on each
core’s load. Introduces the concept of process, i.e. threads accessing the same
set of resources.</li><li><strong>Loader</strong> : provides static module initialization capabilities and dynamic
modules / libraries loading / unloading capabilities.</li><li><strong>File system</strong> : tracks resources processes can use, manages their access.</li><li><strong>Resource tracker</strong> : tracks resources used by each process, and frees them
automatically when the process terminates.</li></ul><h1 class="relative group">Modules<div id=modules class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#modules aria-label=Anchor>#</a></span></h1><p>The previous section introduced a particular block of the kernel, the loader,
that was in the centre of one of the issues I encountered, the Loader.</p><p>It is not my intention to go into details regarding the internals of the loader,
as this would be long enough for an entire article. Yet, as having a clear
comprehension of the concept of modules is essential for understanding the
following sections, we will introduce it.</p><p>We can divide the software that will be executed at runtime in two categories :</p><ul><li><strong>kernel</strong> : contains all blocks previously mentioned, i.e. blocks required to
manage resources, and to run user code. Kernel code must be linked statically
to form the kernel executable.</li><li><strong>modules</strong> : code that is not strictly required in the kernel executable, and
so, that can be <strong>dynamically loaded</strong>.</li></ul><p>For example, the file system is a component of the kernel, but the code to
support a particular type of file manager (ext2, ext4, ntfs) can be provided in
a module.</p><p>Now that this nuance is introduced, we next need to introduce the concept of
static modules and introduce their use case.</p><p>On certain platforms, the RAM memory sections are not executable, this implies
that Writable memory can’t be executed, and so, such dynamic loading is
impossible, as dynamically loading a module means writing it to memory from an
external source, and modifying it (ex : applying relocations) such that it can
access kernel symbols (functions and variables).</p><p>In these platforms, dynamic loading will be impossible, and all required modules
should be linked statically to the kernel executable.</p><p>On other environments, like WebAssembly, the executable format is atypical, and
dynamic loading may be difficult. Even if a loader implementation for such a
format may be possible, it will require a lot more development effort than what
I was willing to invest. In such a situation statically linked modules there
again seem like a valid option, even if only as a temporary solution.</p><p>Another benefit of linking modules statically to the kernel executable is time,
dynamic loading being a complex problem with complex and time-consuming
solutions. Doing the linking work at compile time avoids the need to do it at
each execution.</p><p>A module being an implementation-defined executable aiming to have a
user-defined impact on the kernel (for example, to start processes or to provide
support for file system types), it must comprise a function accomplishing the
aforementioned tasks, the module initialization function, that the loader can
find and execute .</p><p>This execution will be done at different times, depending on the module type :</p><ul><li>For <strong>static modules</strong>, all init functions of static modules must be retrieved
at once and executed sequentially, possibly in a particular order.</li><li>For <strong>dynamic modules</strong>, the init function must be executed as soon as the
module is loaded in the kernel.</li></ul><p>Again, what will be of interest here will be the case of static modules.</p><p>At a high level the build procedure of static modules in our kernel works as the
following :</p><ul><li>Source files of the same module are compiled independently.</li><li>Source files of the same module are merged to form a single relocatable
executable, the module executable.</li><li>Module executables are modified, by possibly forcing symbols locality to
prevent multiple symbols definitions.</li><li>Module executables are merged to form a single relocatable executable, the
static modules executable.</li></ul><p>During this process multiple static modules executables will be generated, each
one having its own initialization function. Later, they will be merged into a
single relocatable executable, and the position of these functions in the
resulting executable may not be known.</p><p>Not knowing the position in the executable of each module’s initialization
function will be an issue as, at runtime, the kernel will have to execute each
one of these functions, but the kernel being independent of modules, it has no
knowledge a priori of the location of these functions.</p><p>There are two strategies one can use to help overcome this hurdle.</p><p>The first, and most common solution involved using the concept of sections,
supported by the elf format. Practically this involves defining for each module
a static function pointer that contains the location of the module’s
initialization function, and placing this variable in a custom section of the
efl. We shall be calling this custom elf section the <code>.modinit</code>.</p><p>Later in the build process, during the merging of multiple static modules
executables, the linker (ld) will merge the content of sections with the same
name (default behaviour, but can be configured with the use of a linker script),
in our case this means merging into one section the multiple static modules
<code>.modinit</code> content. This will cause all our pointers to be located in the same
output section, which in the resulting executable, will cause them to be located
contiguously in memory.</p><p>A wisely crafted linker script provided to the linker will define two global
variables, <code>.modinit_start</code> and <code>.modinit_end</code>, used to help the kernel locate
the start and end of this section, which will allow the kernel to retrieve
addresses of all modules initialization functions needed to execute them.</p><p>This aforementioned process is the one that regular executable processes use to
trigger the</p><p>initialization and de-initialization of static variables whose expressions need
to be computed at run time.</p><p>For more details : <a href=http://ftp.math.utah.edu/u/ma/hohn/linux/misc/elf/elf.html target=_blank>ELF: From The Programmer&rsquo;s
Perspective</a></p><p>The second solution, which is in my humble opinion much less elegant and relies
on knowing at compile-time the full list of static modules that need to be
compiled and linked, consists in providing a unique name to each initialization
function (derived from the module name, modules names must be unique), and to
assign a global visibility to this function, then to define a single function
calling each initialization function by name. The kernel then only needs to
execute this function to initialize all modules.</p><p>Though being un-clever, this procedure can be done automatically using a bash
script.</p><p>In my pre-WebAssembly implementation, I used the first solution. This was only
possible because I had easy access to the standard elf format as I was
developing for the linux environment. But, as we will now observe, WebAssembly’s
constraints on the elf format forced me to review my choice and opt for the
second solution.</p><p>In-process kernels, WebAssembly and their difficulties to cohabitate.</p><p>The second solution, which is in my humble opinion much less elegant and relies
on knowing at compile-time the full list of static modules that need to be
compiled and linked, consists in providing a unique name to each initialization
function (derived from the module name, modules names must be unique), and to
assign a global visibility to this function, then to define a single function
calling each initialization function by name. The kernel then only needs to
execute this function to initialize all modules.</p><p>Though being un-clever, this procedure can be done automatically using a bash
script.</p><p>In my pre-WebAssembly implementation, I used the first solution. This was only
possible because I had easy access to the standard elf format as I was
developing for the linux environment. But, as we will now observe, WebAssembly’s
constraints on the elf format forced me to review my choice and opt for the
second solution.</p><p>In-process kernels, WebAssembly and their difficulties to cohabitate.</p></div></div><script>var oid="views_projects/kernel_to_wasm_p1.md",oid_likes="likes_projects/kernel_to_wasm_p1.md"</script><script type=text/javascript src=/briztal.github.io/js/page.min.b06a29d42a4ed16787978e2eee1e8c797b7698db2bc14ccee78f5c80ac566fc996190a73ad80a5e987558474b20b96fa38f7d85b405f165ff72b7b163c5ad11b.js integrity="sha512-sGop1CpO0WeHl44u7h6MeXt2mNsrwUzO549cgKxWb8mWGQpzrYCl6YdVhHSyC5b6OPfYW0BfFl/3K3sWPFrRGw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=briztal.github.io/projects/memory_management/mm_2/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Memory Manager : Secondary allocators.</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2021-09-21T00:00:00+00:00>21 September 2021</time></span></span></a></span>
<span><a class="flex text-right group ml-3" href=briztal.github.io/projects/kernel_to_wasm_p2/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Joys of porting a kernel to WebAssembly, Part 2.</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2021-10-08T00:00:00+00:00>8 October 2021</time></span></span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/briztal.github.io/js/process.min.62060bb247f4de2b6dde45903668fefb68d792f365587605177b1227c0cf43588701edaca0cb40e2c8e2789bd5ce67c1d2a215b9fb258c3496a7cd25e7cb5fdf.js integrity="sha512-YgYLskf03itt3kWQNmj++2jXkvNlWHYFF3sSJ8DPQ1iHAe2soMtA4sjieJvVzmfB0qIVufsljDSWp80l58tf3w=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=briztal.github.io style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>